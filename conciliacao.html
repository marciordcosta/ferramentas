<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Conciliação</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    /* ===========================
   PAINEL PRINCIPAL (uploads + filtros)
=========================== */
    .painel-horizontal {
      display: flex;
      margin-top: 25px;
      gap: 25px;
      padding: 18px;
      border: 1px solid #d0d0d0;
      border-radius: 10px;
      background: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    /* UPLOADS */
    .col-upload {
      width: 350px;
      border-right: 1px solid #e0e0e0;
      padding-right: 18px;
    }

    .col-upload label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .col-upload input[type="file"] {
      font-size: 13px;
      color: #a3a3a3;
    }

    /* FILTROS */
    .col-filtros {
      display: grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 30px;
      row-gap: 4px;
      padding-top: 4px;
      min-width: 360px;
      align-items: start;
    }

    .titulo-filtro {
      grid-column: 1 / -1;
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 2px;
      border-bottom: 1px solid #ccc;
      width: 100%;
    }

    .fLinha {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .fLinha label {
      min-width: 90px;
      font-size: 14px;
    }

    .fLinha-lateral {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
      grid-column: 2;
      grid-row: 2 / span 3;
      align-self: stretch;
    }

    .linha-filtros-botoes {
      display: flex !important;
      flex-direction: row !important;
      gap: 10px !important;
      align-items: center !important;
    }

    .btnCinza {
      background: #ffc805 !important;
    }

    .col-filtros select {
      min-width: 124px;
    }

    .col-filtros select,
    .col-filtros input[type="date"] {
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .col-upload button,
    .btnFiltro {
      width: 90px;
      padding: 3px;
      font-size: 13px;
      color: #131313;
      cursor: pointer;
      border-radius: 10px;
      border: none;
      background: #d3d3d3;
    }

    #btnConciliarAuto {
      background: #00841d;
      color: #ffffff;
    }

    /* novos botões topo */
    .topo-acoes {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      align-items: center;
    }

    .painel-oculto {
      display: none;
    }

    /* ===========================
   LISTAGEM / PAINÉIS LADO A LADO
=========================== */
    .container {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    #btnConciliar {
      display: none !important;
    }

    .panel {
      flex: 1;
      border: 1px solid #ccc;
      padding: 5px 20px;
      max-height: calc(100vh - 70px);
      height: auto;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .title {
      font-weight: bold;
      font-size: 15px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #ccc;
    }

    /* bloco de duas datas */
    .bloco-datas {
      grid-column: 1;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .linha-data {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .linha-data-fim {
      margin-top: -4px;
    }

    /* coluna dos botões Exportar / Salvar */
    .col-acoes-superior {
      display: flex;
      flex-direction: row;
      gap: 10px;
      align-items: flex-start;
      justify-content: flex-start;
      margin-left: 60px;
    }

    /* botões topo */
    .btn-acao-topo {
      width: 80px;
      padding: 5px 10px;
      border-radius: 8px;
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-acao-topo.azul {
      background: #4aa3ff;
    }

    .btn-acao-topo.verde {
      background: #28a745;
    }

    .btn-acao-topo.vermelho {
      background: #ff2a12;
    }

    .lista-arquivos-importados {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 10px;
      font-size: 14px;
      color: #444;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      border-bottom: 1px solid #ddd;
    }

    .arquivo-tag {
      color: #444;
      font-weight: bold;
    }

    .arquivo-tag span {
      cursor: pointer;
      margin-left: 6px;
      color: red;
      font-weight: bold;
    }

    .arquivos-superiores {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin: 10px 0;
      padding: 8px 5px;
    }

    .arquivos-coluna {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 14px;
      font-weight: bold;
    }

    .arquivos-coluna .arquivo-tag {
      color: #444;
    }

    .arquivos-coluna .arquivo-tag span {
      cursor: pointer;
      margin-left: 4px;
      color: red;
      font-weight: bold;
    }

    .painel-arquivos {
      display: flex;
      justify-content: space-between;
    }

    .arquivos-coluna {
      width: 48%;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .arquivos-coluna.left {
      text-align: left;
    }

    .arquivos-coluna.right {
      text-align: right;
    }

    .desativado {
      opacity: 0.35 !important;
      filter: grayscale(100%) !important;
    }


    /* ===========================
   ITENS DE LISTA
=========================== */
    .item {
      padding: 6px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      position: relative;
      transition: background 0.15s;
    }

    .item:hover {
      background: #f3f3f3;
    }

    .selected {
      background: #cce5ff !important;
    }

    .conciliated {
      background: #d4edda !important;
    }


    button {
      padding: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      border-radius: 6px;
      border: 1px solid #b7b7b7;
      background: #51a5fb;
      color: #fff;
    }

    .btn-add-manual {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: none;
      color: rgb(67, 176, 255);
      border: none;
      font-size: 25px;
      font-weight: normal;
      cursor: pointer;
      padding: 0;
      margin-left: 5px;
    }

    .searchbox {
      width: 300px;
      padding: 8px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #ffffff;
      color: #333;
    }

    .searchbox::placeholder {
      color: #999;
    }

    /* FIXAR CABEÇALHO DOS PAINÉIS */
    .fixed-header {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 5000;
      padding-top: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #ccc;
    }

    /* ===========================
   RODAPÉ / PAINEL DIFERENÇA
=========================== */
    #painelDiferenca {
      top: 160px;
      right: 40px;
      /* posição inicial */
      left: auto;
      padding: 10px 15px;
      background: #d4f8d4;
      border-radius: 5px;
      font-weight: bold;
      font-size: 14px;
      z-index: 999999;
      cursor: grab;
      min-width: 180px;
      display: inline-block;
      /* evita esticar */
    }

    #painelDiferenca:active {
      cursor: grabbing;
    }

    .float-diff:active {
      cursor: grabbing;
    }

    #totaisRodape {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #e7e7e7;
      border-top: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      z-index: 9999;
    }

    #totaisRodape>div:first-child {
      text-align: left;
    }

    #totaisRodape>div:last-child {
      margin-left: auto;
      margin-right: 30px;
    }

    .sistema-header {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* ===========================
   MODAL DE REGISTRO MANUAL
=========================== */

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.45);
      z-index: 99999;
      align-items: center;
      justify-content: center;
    }

    .modal-box {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      width: 350px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
      font-family: Arial, sans-serif;
      position: relative;
      cursor: move;
    }

    .modal-box h2 {
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 18px;
      padding-bottom: 8px;
    }

    .modal-box label {
      font-size: 13px;
    }

    .modal-input {
      width: 100%;
      height: 20px;
      padding: 6px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 13px;
    }

    .modal-buttons {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-modal-save {
      padding: 6px 16px;
      background: #4aa3ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-modal-cancel {
      padding: 6px 16px;
      background: #ddd;
      color: black;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <div style="position:absolute; top:5px; right:25px;">
    <a href="#" id="togglePainel" style="
      font-size:14px;
      color:#919191;
      text-decoration:none;
      cursor:pointer;
    ">
      Ocultar painel
    </a>
  </div>

  <div id="painelDiferenca">Diferença: R$ 0,00</div>

  <!-- ====== UPLOADS ====== -->
  <div class="painel-horizontal" id="painelTopo">

    <!-- COLUNA 1 — UPLOADS -->
    <div class="col-upload">
      <label>Arquivos OFX:</label>
      <input type="file" id="ofxFiles" accept=".ofx" multiple><br><br>

      <label>Relatórios HTML (Sistema):</label>
      <input type="file" id="htmlFile" accept=".html,.htm" multiple><br><br>

      <div style="display:flex; gap:10px;">
        <button id="processBtn">Carregar</button>
        <button id="btnConciliarAuto">Conciliar</button>
      </div>
    </div>

    <!-- COLUNA 2 — FILTROS -->
    <div class="col-filtros">

      <label class="titulo-filtro">Filtros</label>

      <!-- COLUNA ESQUERDA -->
      <div class="filtros-col">
        <div class="fLinha">
          <label>Arquivo:</label>
          <select id="filterBanco"></select>
        </div>

        <div class="fLinha bloco-datas">
          <div class="linha-data">
            <label>Data início:</label>
            <input type="date" id="filterDataInicio">
          </div>
          <div class="linha-data linha-data-fim">
            <label>Data fim:</label>
            <input type="date" id="filterDataFim">
          </div>
        </div>
      </div>

      <!-- COLUNA DIREITA -->
      <div class="filtros-col">
        <div class="fLinha">
          <label>Forma Pagto:</label>
          <select id="filterTipo">
            <option value="">Todos</option>
            <option value="PIX">PIX</option>
            <option value="CARTAO">Cartão</option>
            <option value="BOLETO">Boleto</option>
            <option value="OUTRO">Outro</option>
          </select>

        </div>

        <div class="fLinha">
          <label>Tipo Relatório:</label>
          <select id="filterKind">
            <option value="">Todos</option>
            <option value="receber">Entrada</option>
            <option value="pagar">Saída</option>
          </select>
        </div>

        <div class="fLinha">
          <label>Conciliação:</label>
          <select id="filterConciliado">
            <option value="">Todos</option>
            <option value="sim">Conciliados</option>
            <option value="nao">Não conciliados</option>
            <option value="marcados">Marcados</option>
          </select>
        </div>

      </div>

      <div class="linha-filtros-botoes">
        <button id="limparFiltros" class="btnFiltro btnCinza">Limpar</button>
      </div>

    </div>

    <!-- COLUNA 3 — BOTÕES DE AÇÃO -->
    <div class="col-acoes-superior">
      <button id="btnExportarTopo" class="btn-acao-topo azul">
        Exportar
      </button>

      <button id="btnSalvarTopo" class="btn-acao-topo verde">
        Salvar
      </button>

      <button id="btnLimparTopo" class="btn-acao-topo vermelho">
        Limpar
      </button>
    </div>

  </div>

  <!-- LISTA DE ARQUIVOS IMPORTADOS -->
  <div class="painel-arquivos">
    <div class="arquivos-coluna" id="arquivosOFX"></div>
    <div class="arquivos-coluna" id="arquivosSYS"></div>
  </div>


  <!-- ====== PAINÉIS PRINCIPAIS ====== -->
  <div class="container">

    <!-- LEFT: OFX -->
    <div class="panel" id="panelBanco">
      <div class="title fixed-header" style="display:flex; justify-content:space-between; align-items:center;">
        <span>Banco (OFX)</span>
        <input id="searchBanco" type="text" placeholder="pesquisa…" class="searchbox">
      </div>
      <div id="listaBanco"></div>
    </div>

    <!-- RIGHT: SISTEMA -->
    <div class="panel" id="panelSistema">
      <div class="title fixed-header" style="display:flex; justify-content:space-between; align-items:center;">

        <div class="sistema-header">
          <span>Sistema (HTML)</span>
          <button id="btnAddManual" class="btn-add-manual">+</button>
        </div>

        <input id="searchSistema" type="text" placeholder="pesquisa…" class="searchbox">
      </div>
      <div id="listaSistema"></div>
    </div>

  </div>

  <div id="totaisRodape">

    <div>
      <b>OFX:</b>
      Registros: <span id="t_ofx_regs">0</span> |
      Entradas: <span id="t_ofx_in">0</span> |
      Saídas: <span id="t_ofx_out">0</span> |
      <b>Saldo:</b> <span id="t_ofx_saldo">0,00</span>
    </div>

    <div>
      <b>Sistema:</b>
      Registros: <span id="t_sys_regs">0</span> |
      Entradas: <span id="t_sys_in">0</span> |
      Saídas: <span id="t_sys_out">0</span> |
      <b>Saldo:</b> <span id="t_sys_saldo">0,00</span>
    </div>

  </div>


  <div id="ctxMenu" style="
    position:absolute;
    display:none;
    background:#ffffff;
    border:1px solid #ccc;
    padding:5px 0;
    border-radius:4px;
    z-index:999999;
    font-size:14px;
    min-width:150px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
">
    <div id="ctxToggle" style="padding:8px 12px; cursor:pointer; user-select:none;">
      Desativar
    </div>

    <div id="ctxConcManual" style="
      padding:8px 12px; 
      cursor:pointer; 
      user-select:none;
      border-top:1px solid #eee;
  ">
      Conciliar manual (Sistema → OFX)
    </div>
  </div>

  <!-- MODAL PARA ADICIONAR REGISTRO MANUAL -->
  <div id="modalAddManual" class="modal-overlay">

    <div class="modal-box">
      <h2>Novo Registro</h2>

      <label>Data:</label>
      <input type="date" id="m_data" class="modal-input">

      <label>Valor:</label>
      <input type="number" step="0.01" id="m_valor" class="modal-input">

      <label>Cliente:</label>
      <input type="text" id="m_cliente" class="modal-input">

      <label>NF:</label>
      <input type="text" id="m_nf" class="modal-input">

      <div class="modal-buttons">
        <button id="btnSalvarManual" class="btn-modal-save">Salvar</button>
        <button id="btnCancelarManual" class="btn-modal-cancel">Cancelar</button>
      </div>

    </div>

  </div>

  <div id="popupSugestoes" style="
    display:none;
    position:fixed;
    top: 0;
    left: 0;
    margin-left: 10px;
    margin-top: 10px;
    width:280px;
    color: #fff;
    background:rgba(0,0,0,0.80);
    border:1px solid #ccc;
    border-radius:8px;
    box-shadow:0 3px 12px rgba(0,0,0,0.25);
    padding:12px;
    z-index:999999;
    font-family:Arial, sans-serif;
">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b>Sugestões de Conciliação</b>
      <span id="popupSugestoesClose" style="
        cursor:pointer;
        color: #ff0000;
    ">X</span>
    </div>

    <div id="popupSugestoesBody" style="margin-top:10px; font-size:13px; max-height:300px; overflow-y:auto;">
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const painel = document.getElementById("painelTopo");
      const btn = document.getElementById("togglePainel");

      if (!painel || !btn) return;

      let visivel = true;

      btn.addEventListener("click", () => {
        visivel = !visivel;

        painel.classList.toggle("painel-oculto", !visivel);
        btn.textContent = visivel ? "Ocultar painel" : "Mostrar painel";
      });
    });
  </script>

  <script src="js/conciliacao.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("btnConciliarAuto");
      if (!btn) return;

      btn.addEventListener("click", () => {
        conciliacaoAutomatica();
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("painelDiferenca");
      if (!el) return;

      // garante estilo base
      el.style.position = "fixed";
      el.style.boxSizing = "border-box";
      el.style.minWidth = el.style.minWidth || "140px";

      // converte RIGHT -> LEFT uma única vez (se não convertido)
      const rect = el.getBoundingClientRect();
      if (!el.style.left || el.style.left === "" || el.style.left === "auto") {
        el.style.left = Math.max(8, Math.round(rect.left)) + "px";
        el.style.top = Math.max(8, Math.round(rect.top)) + "px";
        el.style.right = "auto";
      }

      let dragging = false;
      let startX = 0, startY = 0;
      let origUserSelect = "";

      function getClientX(e) { return (e.touches ? e.touches[0].clientX : e.clientX); }
      function getClientY(e) { return (e.touches ? e.touches[0].clientY : e.clientY); }

      function onStart(e) {
        e.preventDefault();
        dragging = true;

        // garante valores numéricos para left/top
        const curLeft = parseFloat(el.style.left) || el.getBoundingClientRect().left;
        const curTop = parseFloat(el.style.top) || el.getBoundingClientRect().top;

        startX = getClientX(e) - curLeft;
        startY = getClientY(e) - curTop;

        // visual
        el.style.cursor = "grabbing";
        el.style.zIndex = 1000000;

        // bloqueia seleção de texto durante o drag
        origUserSelect = document.body.style.userSelect;
        document.body.style.userSelect = "none";
      }

      function onMove(e) {
        if (!dragging) return;
        const x = Math.round(getClientX(e) - startX);
        const y = Math.round(getClientY(e) - startY);

        // limites simples para não sair totalmente da tela
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        const elW = el.offsetWidth;
        const elH = el.offsetHeight;

        const clampX = Math.min(Math.max(8, x), Math.max(8, winW - elW - 8));
        const clampY = Math.min(Math.max(8, y), Math.max(8, winH - elH - 8));

        el.style.left = clampX + "px";
        el.style.top = clampY + "px";
      }

      function onEnd() {
        if (!dragging) return;
        dragging = false;
        el.style.cursor = "grab";
        document.body.style.userSelect = origUserSelect || "";
      }

      // mouse
      el.addEventListener("mousedown", onStart);
      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onEnd);

      // touch
      el.addEventListener("touchstart", onStart, { passive: false });
      document.addEventListener("touchmove", onMove, { passive: false });
      document.addEventListener("touchend", onEnd);

      // reforça posição após redimensionamento da janela
      window.addEventListener("resize", () => {
        const l = parseFloat(el.style.left) || el.getBoundingClientRect().left;
        const t = parseFloat(el.style.top) || el.getBoundingClientRect().top;
        const winW = window.innerWidth, winH = window.innerHeight;
        const elW = el.offsetWidth, elH = el.offsetHeight;
        el.style.left = Math.min(Math.max(8, l), Math.max(8, winW - elW - 8)) + "px";
        el.style.top = Math.min(Math.max(8, t), Math.max(8, winH - elH - 8)) + "px";
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const popup = document.getElementById("popupSugestoes");
      if (!popup) return;

      const header = popup.firstElementChild;
      if (!header) return;

      popup.style.position = "fixed";
      popup.style.cursor = "default";
      header.style.cursor = "move";

      let dragging = false;
      let offsetX = 0;
      let offsetY = 0;

      header.addEventListener("mousedown", e => {
        e.preventDefault();
        dragging = true;

        const rect = popup.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;

        popup.style.zIndex = 1000000;
        document.body.style.userSelect = "none";
      });

      document.addEventListener("mousemove", e => {
        if (!dragging) return;

        const x = e.clientX - offsetX;
        const y = e.clientY - offsetY;

        popup.style.left = Math.max(8, x) + "px";
        popup.style.top = Math.max(8, y) + "px";
      });

      document.addEventListener("mouseup", () => {
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = "";
      });
    });
  </script>


  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    const { createClient } = window.supabase;

    const SUPABASE_URL = "https://wnmtkoywbbzolbkoawva.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // e-mail autorizado
    const EMAIL_PERMITIDO = "cearasementes@gmail.com";

    // executado quando a página abre
    async function verificarLogin() {
      const { data } = await supabase.auth.getSession();
      const session = data.session;

      // não está logado → volta para a página de login
      if (!session) {
        window.location.href = "index.html"; // altere se seu login estiver em outro arquivo
        return;
      }

      const email = session.user.email;

      // logado, mas não autorizado
      if (email !== EMAIL_PERMITIDO) {
        alert("Acesso negado.");
        await supabase.auth.signOut();
        window.location.href = "index.html";
        return;
      }

      // autorizado → liberar a página
      console.log("Acesso autorizado:", email);
    }

    verificarLogin();
  </script>

</body>

</html>
