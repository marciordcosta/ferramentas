<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciador Completo</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{margin:0;background:#f4f4f4;font-family:Arial}
#layout{display:flex;height:100vh}
#sidebar{width:250px;background:#fff;border-right:1px solid #ddd;overflow:auto;padding:12px}
#content{flex:1;overflow:auto;padding:20px}
.folder{padding:6px 8px;border-radius:6px;cursor:pointer;margin-bottom:4px}
.folder:hover{background:#e9f2ff}
.breadcrumb span{cursor:pointer;color:#2c7be5}
.dragzone{border:2px dashed #aaa;padding:30px;text-align:center;border-radius:12px;background:#fafafa;margin-bottom:16px}
.dragzone.hover{border-color:#2c7be5;background:#eef5ff}
.item{background:#fff;padding:12px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}
.item .actions button{font-size:11px;padding:4px 6px}
</style>
</head>
<body>
<div id="layout">
    <!-- SIDEBAR -->
    <div id="sidebar">
        <strong>Pastas</strong>
        <div id="sideFolders" style="margin-top:10px"></div>
        <hr>
        <input id="novaPasta" placeholder="Nova pasta" style="width:100%;margin-bottom:6px">
        <button onclick="criarPasta()" style="width:100%">Criar Pasta</button>
    </div>

    <!-- CONTENT -->
    <div id="content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div id="breadcrumb" class="breadcrumb"></div>
            <div><span id="userEmail"></span> | <a onclick="logout()" style="color:red;cursor:pointer">sair</a></div>
        </div>

        <!-- DRAG AREA -->
        <div id="dragzone" class="dragzone">Arraste arquivos aqui para enviar</div>

        <!-- SEARCH + SORT -->
        <div style="display:flex;gap:10px;margin-bottom:16px;">
            <input type="text" id="busca" placeholder="Buscar arquivos..." style="flex:1;">
            <button onclick="buscar()">Buscar</button>
            <select id="ordenar" onchange="ordenarArquivos()">
                <option value="nome">Nome</option>
                <option value="data">Data</option>
                <option value="tamanho">Tamanho</option>
            </select>
        </div>

        <!-- FILE LIST -->
        <div id="resultados"></div>
    </div>
</div>

<script>
const {createClient} = window.supabase;
const supabase = createClient("https://wnmtkoywbbzolbkoawva.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk");
const BUCKET = "Arquivos";
let pastaAtual = "";
let arquivosDaPasta = [];

function clean(p){return (p||"").replace(/^\/+|\/+$/g,"")}

// ---------------- AUTH ------------------
async function ensureAuth(){
  const {data}=await supabase.auth.getSession();
  if(!data.session) return location.href="index.html";
  if(data.session.user.email!=="cearasementes@gmail.com") return logout();
  userEmail.innerText=data.session.user.email;
}
async function logout(){await supabase.auth.signOut();location.href="index.html"}

// ---------------- CARREGAR PASTAS ------------------
async function carregarPastas(){
  const lado=sideFolders;
  lado.innerHTML="";
  const todas = await listarPastasRecursivo();
  todas.forEach(p=>{
    const div=document.createElement("div");
    let nivel = p.split("/").length - 1;
    div.className="folder";
    div.style.paddingLeft = (nivel*16)+"px";
    div.innerText = p;
    div.onclick=()=>abrirPasta(p);
    lado.appendChild(div);
  });
}

async function listarPastasRecursivo(){
  let found=[];
  async function scan(prefix){
    const {data}=await supabase.storage.from(BUCKET).list(prefix,{limit:1000});
    if(!data) return;
    for(const it of data){
      const full=clean(prefix?`${prefix}/${it.name}`:it.name);
      const probe=await supabase.storage.from(BUCKET).list(full,{limit:1});
      if(Array.isArray(probe.data)){
        found.push(full);
        await scan(full);
      }
    }
  }
  await scan("");
  return found;
}

// ---------------- ABRIR PASTA ------------------
async function abrirPasta(p){
  pastaAtual = p;
  atualizarBreadcrumb();
  const r=resultados;
  r.innerHTML="";
  const {data}=await supabase.storage.from(BUCKET).list(p,{limit:1000});
  arquivosDaPasta=[];
  for(const it of data){
    const full=`${p}/${it.name}`;
    const probe=await supabase.storage.from(BUCKET).list(full,{limit:1});
    if(!Array.isArray(probe.data) && it.name!==".init"){
      arquivosDaPasta.push({path:full,name:it.name,size:it.metadata?.size||0,date:it.created_at||""});
    }
  }
  ordenarArquivos();
}

function atualizarBreadcrumb(){
  const bc=breadcrumb;
  bc.innerHTML="";
  let partes = pastaAtual.split("/");
  let caminho="";
  partes.forEach((p,i)=>{
    caminho = i===0 ? p : caminho+"/"+p;
    const span=document.createElement("span");
    span.innerText=p;
    span.onclick=()=>abrirPasta(caminho);
    bc.appendChild(span);
    if(i<partes.length-1) bc.innerHTML += " > ";
  });
}

// ---------------- RENDER ------------------
function renderLista(){
  const r=resultados;
  r.innerHTML="";
  arquivosDaPasta.forEach(a=>{
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`<strong>${a.name}</strong>
    <div class=muted>${a.path}</div>
    <div class=actions>
      <button onclick="baixar('${encodeURIComponent(a.path)}')">Baixar</button>
      <button class=btn-sec onclick="renomear('${encodeURIComponent(a.path)}')">Ren</button>
      <button class=btn-sec onclick="mover('${encodeURIComponent(a.path)}')">Mov</button>
      <button class=btn-danger onclick="excluirArquivo('${encodeURIComponent(a.path)}')">X</button>
    </div>`;
    r.appendChild(el);
  });
}

// ---------------- ORDENAR ------------------
function ordenarArquivos(){
  const mode = ordenar.value;
  if(mode==="nome") arquivosDaPasta.sort((a,b)=>a.name.localeCompare(b.name));
  if(mode==="tamanho") arquivosDaPasta.sort((a,b)=>b.size-a.size);
  if(mode==="data") arquivosDaPasta.sort((a,b)=>new Date(b.date)-new Date(a.date));
  renderLista();
}

// ---------------- AÇÕES ------------------
async function baixar(p){p=decodeURIComponent(p);const {data}=await supabase.storage.from(BUCKET).download(p);const a=document.createElement("a");a.href=URL.createObjectURL(data);a.download=p.split("/").pop();a.click();}
async function excluirArquivo(p){p=decodeURIComponent(p);if(!confirm("Excluir?"))return;await supabase.storage.from(BUCKET).remove([p]);abrirPasta(pastaAtual);}
async function renomear(p){p=decodeURIComponent(p);const nome=p.split("/").pop();const pasta=p.replace(/\/[^/]+$/,"");const novo=prompt("Novo nome",nome);if(!novo)return;await supabase.storage.from(BUCKET).move(p,`${pasta}/${novo}`);abrirPasta(pastaAtual);}
function mover(p){moverAlvo=decodeURIComponent(p);abrirPastasMover();}

// mover destinosync function moverPara(dest){const nome=moverAlvo.split("/").pop();await supabase.storage.from(BUCKET).move(moverAlvo,`${dest}/${nome}`);abrirPasta(pastaAtual);}

// ---------------- PASTA (CRIAR / MOVER DEST) ------------------
async function criarPasta(){let n=clean(novaPasta.value);if(!n)return;await supabase.storage.from(BUCKET).upload(`${n}/.init`,new Blob([""]));novaPasta.value="";carregarPastas();}

// ---------------- BUSCA ------------------
async function buscar(){let t=busca.value.trim().toLowerCase();if(!t){alert("Digite algo");return;}const todas=await listarArquivosGlobais();const f=todas.filter(a=>a.path.toLowerCase().includes(t));arquivosDaPasta=f;renderLista();}

async function listarArquivosGlobais(){let out=[];async function scan(prefix){const {data}=await supabase.storage.from(BUCKET).list(prefix,{limit:1000});if(!data)return;for(const it of data){const full=clean(prefix?`${prefix}/${it.name}`:it.name);const probe=await supabase.storage.from(BUCKET).list(full,{limit:1});if(Array.isArray(probe.data))await scan(full);else if(it.name!==".init") out.push({path:full,name:it.name,size:it.metadata?.size||0,date:it.created_at||""});}}await scan("");return out;}

// ---------------- DRAG & DROP ------------------
const dz = dragzone;
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('hover')});
dz.addEventListener('dragleave',()=>dz.classList.remove('hover'));
dz.addEventListener('drop',async e=>{
  e.preventDefault();dz.classList.remove('hover');
  if(!pastaAtual){alert("Abra uma pasta primeiro.");return;}
  for(const file of e.dataTransfer.files){await supabase.storage.from(BUCKET).upload(`${pastaAtual}/${file.name}`,file,{upsert:true});}
  abrirPasta(pastaAtual);
});

// INIT
(async()=>{await ensureAuth();await carregarPastas();})();
</script>
</body>
</html>
