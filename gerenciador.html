<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gerenciador de Arquivos</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root { --primary:#2c7be5; --primary-2:#1a5fcc; --ok:#28a745; --danger:#d9534f; --muted:#666; }
  *{box-sizing:border-box}
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:24px; }
  .wrap { max-width: 1000px; margin: 0 auto; }
  .card { background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); padding:18px; margin-bottom:16px; }
  button { padding:8px 12px; border:none; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer; font-size:13px; }
  button:hover { background:var(--primary-2); }
  .btn-sec { background:#6c757d; }
  .btn-sec:hover { background:#545b62; }
  .btn-danger { background:var(--danger); }
  .btn-danger:hover { background:#c33f3b; }
  .btn-ok { background:var(--ok); }
  .btn-ok:hover { background:#1e7e34; }
  .muted { color:var(--muted); font-size:12px; }
  .item .actions button { padding:4px 8px; font-size:11px; }
  .folder .ops button { padding:4px 6px; font-size:11px; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal { width: 700px; max-width:95vw; background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
  .folders { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:10px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <strong>Gerenciador de Arquivos</strong>
    <div><span id="userEmail"></span> <a class="sair" onclick="logout()" style="color:#c1121f;cursor:pointer;">sair</a></div>
  </div>

  <!-- Upload -->
  <div class="card">
    <label>Arquivo</label>
    <input type="file" id="fileInput" />
    <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
      <button class="btn-sec" onclick="abrirPastas()">Selecionar Pasta</button>
      <span class="muted">Destino: <span id="pastaSelecionada" style="font-weight:bold;">Nenhuma</span></span>
    </div>
    <div style="margin-top:12px;"><button class="btn-ok" onclick="uploadFile()">Enviar</button></div>
  </div>

  <!-- Busca -->
  <div class="card">
    <label>Pesquisar (opcional)</label>
    <input type="text" id="busca" placeholder="Digite algo para filtrar"/>
    <div style="margin-top:10px;"><button onclick="buscar()">Buscar</button></div>
  </div>

  <!-- Resultados -->
  <div class="card">
    <strong>Resultados</strong> ‚Äî <span id="countInfo"></span>
    <div id="resultados" style="margin-top:12px;"></div>
  </div>
</div>

<!-- Modal de Pastas -->
<div id="modalPastas" class="modal-backdrop" onclick="fecharPastas(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <header style="padding:10px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;">
      <h3 style="margin:0;font-size:16px;">Pastas</h3>
      <button onclick="fecharPastas()" style="background:none;color:#333;font-size:18px;">‚úï</button>
    </header>
    <div class="body" style="padding:14px;">
      <div style="display:flex;gap:8px;margin-bottom:10px;">
        <input id="novaPasta" type="text" placeholder="Nova pasta"/>
        <button class="btn-ok" onclick="criarPasta()">Criar</button>
      </div>
      <div id="listaPastas" class="folders"></div>
    </div>
  </div>
</div>

<script>
// CONFIG
const { createClient } = window.supabase;
const supabase = createClient("https://wnmtkoywbbzolbkoawva.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk");
const BUCKET = "Arquivos";
let pastaAtual = "";
let foldersIndex = new Set();
let filesIndex = [];

// LOGIN
async function ensureAuth(){
  const { data } = await supabase.auth.getSession();
  if(!data.session){ window.location.href="index.html"; return; }
  if(data.session.user.email !== "cearasementes@gmail.com"){ alert("Acesso negado."); logout(); }
  document.getElementById("userEmail").innerText = data.session.user.email;
}
async function logout(){ await supabase.auth.signOut(); window.location.href="index.html"; }

function clean(p){ return (p||"").replace(/^\/+|\/+$/g,""); }
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }

// INDEXA√á√ÉO RECURSIVA
async function buildIndex(){ foldersIndex.clear(); filesIndex = []; const q=[""]; while(q.length){ const pre=q.shift(); const {data}=await supabase.storage.from(BUCKET).list(pre,{limit:1000}); if(!Array.isArray(data)) continue; for(const it of data){ const full=clean(pre?`${pre}/${it.name}`:it.name); const probe=await supabase.storage.from(BUCKET).list(full,{limit:1}); if(Array.isArray(probe.data)){ foldersIndex.add(full); q.push(full); }else filesIndex.push({path:full}); } } }

// MODAL
function abrirPastas(modoMover=false){
  document.getElementById("modalPastas").dataset.mover = modoMover ? "1" : "0";
  document.getElementById("modalPastas").style.display="flex";
  carregarPastas();
}(){ document.getElementById("modalPastas").style.display="flex"; carregarPastas(); }
function fecharPastas(){ document.getElementById("modalPastas").style.display="none"; }
async function carregarPastas(){ if(!foldersIndex.size) await buildIndex(); const list=[...foldersIndex].sort(); const cont=document.getElementById("listaPastas"); cont.innerHTML=""; for(const p of list){ const el=document.createElement("div"); el.className="folder"; el.ondblclick = () => {
      const moverModo = document.getElementById("modalPastas").dataset.mover === "1";
      if(moverModo){
        moverParaPasta(p);
      } else {
        pastaAtual=p;
        document.getElementById("pastaSelecionada").textContent=p;
        fecharPastas();
        listarArquivosDaPasta(p);
      }
    };=()=>{ pastaAtual=p; document.getElementById("pastaSelecionada").textContent=p; fecharPastas(); listarArquivosDaPasta(p); }; el.innerHTML=`<div>üìÅ</div><div class="name">${escapeHtml(p)}</div>`; cont.appendChild(el); } }
async function criarPasta(){ let nome=clean(document.getElementById("novaPasta").value); if(!nome) return; await supabase.storage.from(BUCKET).upload(`${nome}/.init`, new Blob([""])); document.getElementById("novaPasta").value=""; await buildIndex(); carregarPastas(); }

// UPLOAD
async function uploadFile(){ const file=document.getElementById("fileInput").files[0]; if(!file){alert("Selecione um arquivo");return;} if(!pastaAtual){alert("Selecione uma pasta");return;} const path=`${pastaAtual}/${file.name}`; const {error}=await supabase.storage.from(BUCKET).upload(path,file,{upsert:true}); if(error){alert("Erro no upload");return;} alert("Enviado"); await buildIndex(); listarArquivosDaPasta(pastaAtual); }

// LISTAR
async function listarArquivosDaPasta(prefix){ const r=document.getElementById("resultados"); const c=document.getElementById("countInfo"); r.innerHTML=""; const {data}=await supabase.storage.from(BUCKET).list(prefix,{limit:1000}); const files=[]; for(const it of data){ const full=clean(`${prefix}/${it.name}`); const probe=await supabase.storage.from(BUCKET).list(full,{limit:1}); if(Array.isArray(probe.data)){ continue;} if(it.name!==".init") files.push({path:full}); } c.textContent=`${files.length} arquivo(s)`; for(const f of files) r.appendChild(renderItem(f)); }
function renderItem(it){ const el=document.createElement("div"); el.className="item"; el.innerHTML=`<strong>${escapeHtml(it.path.split("/").pop())}</strong><div class="muted">${escapeHtml(it.path)}</div><div class="actions"><button onclick="baixar('${it.path}')">Baixar</button><button class="btn-sec" onclick="renomear('${it.path}')">Ren</button><button class="btn-sec" onclick="mover('${it.path}')">Mov</button><button class="btn-danger" onclick="excluirArquivo('${it.path}')">X</button></div>`; return el; }

// A√á√ïES
async function moverParaPasta(destino){
  fecharPastas();
  if(!moverAlvo)return;
  destino = destino.trim();
  if(!destino)return;

  const nome = moverAlvo.split("/").pop();
  const newPath = `${destino}/${nome}`;

  const { error } = await supabase.storage.from(BUCKET).move(moverAlvo, newPath);
  if(error){ alert("Falha ao mover."); return; }

  alert("Movido com sucesso.");
  moverAlvo = null;
  await buildIndex();
  listarArquivosDaPasta(pastaAtual);
}
async function baixar(p){ const {data}=await supabase.storage.from(BUCKET).download(p); const url=URL.createObjectURL(data); const a=document.createElement("a"); a.href=url;a.download=p.split("/").pop(); a.click(); }
async function excluirArquivo(p){ if(!confirm("Excluir?"))return; await supabase.storage.from(BUCKET).remove([p]); listarArquivosDaPasta(pastaAtual); }
async function renomear(p){ const nome=p.split("/").pop(); const pasta=p.replace(nome,"").slice(0,-1); const novo=prompt("Novo nome",nome); if(!novo)return; await supabase.storage.from(BUCKET).move(p,`${pasta}/${novo}`); listarArquivosDaPasta(pastaAtual); }
let moverAlvo = null;

async function mover(pathEnc){
  moverAlvo = decodeURIComponent(pathEnc);
  abrirPastas(true); // modo sele√ß√£o para mover
}(p){ const nome=p.split("/").pop(); const pasta=prompt("Mover para:"); if(!pasta)return; await supabase.storage.from(BUCKET).move(p,`${clean(pasta)}/${nome}`); listarArquivosDaPasta(pastaAtual); }

// BUSCA ‚Äî s√≥ funciona se houver termo
async function.buscar(){ const termo=document.getElementById("busca").value.trim().toLowerCase(); const r=document.getElementById("resultados"); const c=document.getElementById("countInfo"); if(!termo){ alert("Digite algo para buscar"); return;} r.innerHTML=""; if(!filesIndex.length) await buildIndex(); const match=filesIndex.filter(f=>f.path.toLowerCase().includes(termo)); c.textContent=`${match.length} arquivo(s)`; for(const f of match) r.appendChild(renderItem(f)); }

(async function(){ await ensureAuth(); await buildIndex(); })();
</script>
</body>
</html>
