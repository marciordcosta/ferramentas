<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gerenciador de Arquivos</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root { --primary:#2c7be5; --primary-2:#1a5fcc; --ok:#28a745; --danger:#d9534f; --muted:#666; }
  *{box-sizing:border-box}
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:24px; }
  .wrap { max-width: 900px; margin: 0 auto; }
  .card { background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); padding:18px; margin-bottom:16px; }
  button { padding:8px 12px; border:none; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer; font-size:13px; }
  button:hover { background:var(--primary-2); }
  .btn-sec { background:#6c757d; }
  .btn-sec:hover { background:#545b62; }
  .btn-danger { background:var(--danger); }
  .btn-danger:hover { background:#c33f3b; }
  .btn-ok { background:var(--ok); }
  .btn-ok:hover { background:#1e7e34; }
  .muted { color:var(--muted); font-size:12px; }
  .item { border:1px solid #eee; border-radius:10px; padding:12px; background:#fafafa; margin-bottom:10px; }
  .item .actions { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
  .item .actions button { padding:4px 8px; font-size:11px; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal { width: 600px; max-width:95vw; background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
  .folders { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; }
  .folder { border:1px solid #eee; border-radius:10px; padding:10px; display:flex; align-items:center; gap:8px; cursor:pointer; background:#fafafa; }
  .folder:hover { background:#f0f7ff; }
  .folder .name { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .folder .ops button { padding:4px 6px; font-size:11px; }
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <strong>Gerenciador de Arquivos</strong>
    <div><span id="userEmail"></span> <a onclick="logout()" style="color:#c1121f;cursor:pointer;">sair</a></div>
  </div>

  <!-- UPLOAD SIMPLIFICADO -->
  <div class="card">
    <label>Selecione um arquivo</label>
    <input type="file" id="fileInput" onchange="abrirPastasUpload()" />
    <div class="muted" style="margin-top:6px;">Ap√≥s escolher o arquivo, selecione a pasta de destino.</div>
  </div>

  <!-- BUSCA + PASTAS -->
  <div class="card">
    <div style="display:flex;gap:10px;">
      <input type="text" id="busca" placeholder="Buscar arquivo..." style="flex:1;" />
      <button onclick="buscar()">Buscar</button>
      <button class="btn-sec" onclick="abrirPastas()">Pastas</button>
    </div>
  </div>

  <!-- Resultados -->
  <div class="card">
    <strong>Resultados</strong> ‚Äî <span id="countInfo"></span>
    <div id="resultados" style="margin-top:12px;"></div>
  </div>
</div>

<!-- MODAL DE PASTAS -->
<div id="modalPastas" class="modal-backdrop" onclick="fecharPastas(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <header style="padding:10px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;font-size:16px;">Pastas</h3>
      <button onclick="fecharPastas()" style="background:none;color:#333;font-size:18px;">‚úï</button>
    </header>
    <div class="body" style="padding:14px;">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input id="novaPasta" type="text" placeholder="Nova pasta"/>
        <button class="btn-ok" onclick="criarPasta()">Criar</button>
      </div>
      <div id="listaPastas" class="folders"></div>
    </div>
  </div>
</div>

<script>
// CONFIG
const { createClient } = window.supabase;
const supabase = createClient("https://wnmtkoywbbzolbkoawva.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk");
const BUCKET = "Arquivos";
let pastaAtual = "";
let fileToUpload = null;
let moverAlvo = null;
let foldersIndex = new Set();
let filesIndex = [];

// AUTH
async function ensureAuth(){
  const { data } = await supabase.auth.getSession();
  if(!data.session) return location.href="index.html";
  const email = data.session.user.email;
  if(email !== "cearasementes@gmail.com"){
    await supabase.auth.signOut();
    return location.href="index.html";
  }
  userEmail.innerText=email;
}
async function logout(){ await supabase.auth.signOut(); location.href="index.html"; }

// HELPERS
const clean = p => (p||"").replace(/^\/+|\/+$/g,"");
const escapeHtml = s => (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));

// INDEXA√á√ÉO
async function buildIndex(){
  foldersIndex.clear(); filesIndex=[];
  const q=[""];
  while(q.length){
    const pre=q.shift();
    const {data}=await supabase.storage.from(BUCKET).list(pre,{limit:1000});
    if(!data) continue;
    for(const it of data){
      const full=clean(pre?`${pre}/${it.name}`:it.name);
      const probe=await supabase.storage.from(BUCKET).list(full,{limit:1});
      if(Array.isArray(probe.data)) foldersIndex.add(full), q.push(full);
      else if(it.name!==".init") filesIndex.push({path:full});
    }
  }
}

// MODAL
function abrirPastas(mover=false){
  modalPastas.dataset.mode = mover ? "move" : fileToUpload ? "upload" : "open";
  modalPastas.style.display="flex";
  carregarPastas();
}
function fecharPastas(){ modalPastas.style.display="none"; }

async function carregarPastas(){
  if(!foldersIndex.size) await buildIndex();
  const cont = listaPastas;
  cont.innerHTML="";
  [...foldersIndex].sort().forEach(p=>{
    const el=document.createElement("div");
    el.className="folder";
    el.innerHTML=`<div>üìÅ</div><div class=name>${escapeHtml(p)}</div>`;
    el.ondblclick=()=> selecionarPasta(p);
    cont.appendChild(el);
  });
}

function selecionarPasta(p){
  const mode = modalPastas.dataset.mode;
  fecharPastas();
  if(mode==="upload"){
    pastaAtual=p;
    enviarArquivo();
  } else if(mode==="move"){
    moverPara(p);
  } else {
    pastaAtual=p;
    listarArquivosDaPasta(p);
  }
}

async function criarPasta(){
  let nome=clean(novaPasta.value);
  if(!nome)return;
  await supabase.storage.from(BUCKET).upload(`${nome}/.init`,new Blob([""]));
  novaPasta.value="";
  await buildIndex(); carregarPastas();
}

// UPLOAD
function abrirPastasUpload(){ fileToUpload = fileInput.files[0]; abrirPastas(); }

async function enviarArquivo(){
  if(!fileToUpload || !pastaAtual){ alert("Selecione o arquivo e uma pasta"); return; }
  const path = `${pastaAtual}/${fileToUpload.name}`;
  const {error}=await supabase.storage.from(BUCKET).upload(path,fileToUpload,{upsert:true});
  if(error){alert("Erro ao enviar");return;}
  fileInput.value="";
  fileToUpload=null;
  await buildIndex(); listarArquivosDaPasta(pastaAtual);
  alert("Arquivo enviado");
}

// LISTAGEM
async function listarArquivosDaPasta(pre){
  const r=resultados, c=countInfo;
  r.innerHTML=""; c.textContent="";
  const {data}=await supabase.storage.from(BUCKET).list(pre,{limit:1000});
  const files=[];
  for(const it of data){
    const full=clean(`${pre}/${it.name}`);
    const probe=await supabase.storage.from(BUCKET).list(full,{limit:1});
    if(Array.isArray(probe.data)) continue;
    if(it.name!==".init") files.push({path:full});
  }
  c.textContent=`${files.length} arquivo(s)`;
  files.forEach(f=>r.appendChild(renderItem(f)));
}

function renderItem(it){
  const el=document.createElement("div"); el.className="item";
  el.innerHTML=`<strong>${escapeHtml(it.path.split("/").pop())}</strong>
  <div class=muted>${escapeHtml(it.path)}</div>
  <div class=actions>
    <button onclick="baixar('${encodeURIComponent(it.path)}')">Baixar</button>
    <button class=btn-sec onclick="renomear('${encodeURIComponent(it.path)}')">Ren</button>
    <button class=btn-sec onclick="mover('${encodeURIComponent(it.path)}')">Mov</button>
    <button class=btn-danger onclick="excluirArquivo('${encodeURIComponent(it.path)}')">X</button>
  </div>`;
  return el;
}

// A√á√ïES
async function baixar(p){ p=decodeURIComponent(p); const {data}=await supabase.storage.from(BUCKET).download(p); const a=document.createElement("a"); a.href=URL.createObjectURL(data); a.download=p.split("/").pop(); a.click(); }
async function excluirArquivo(p){ p=decodeURIComponent(p); if(!confirm("Excluir?"))return; await supabase.storage.from(BUCKET).remove([p]); await buildIndex(); listarArquivosDaPasta(pastaAtual); }
async function renomear(p){ p=decodeURIComponent(p); const nome=p.split("/").pop(); const pasta=p.replace(/\/[^/]+$/,""); const novo=prompt("Novo nome",nome); if(!novo)return; await supabase.storage.from(BUCKET).move(p,`${pasta}/${novo}`); await buildIndex(); listarArquivosDaPasta(pastaAtual); }
function mover(p){ moverAlvo=decodeURIComponent(p); abrirPastas(true); }
async function moverPara(dest){ const nome=moverAlvo.split("/").pop(); await supabase.storage.from(BUCKET).move(moverAlvo,`${dest}/${nome}`); await buildIndex(); listarArquivosDaPasta(pastaAtual); }

// BUSCA
async function buscar(){
  const termo=busca.value.trim().toLowerCase();
  if(!termo){alert("Digite algo para buscar");return;}
  if(!filesIndex.length) await buildIndex();
  const match=filesIndex.filter(f=>f.path.toLowerCase().includes(termo));
  resultados.innerHTML="";
  countInfo.textContent=`${match.length} arquivo(s)`;
  match.forEach(f=>resultados.appendChild(renderItem(f)));
}

// INIT
(async()=>{ await ensureAuth(); await buildIndex(); })();
</script>
</body>
</html>
