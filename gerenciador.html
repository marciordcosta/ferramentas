<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gerenciador de Arquivos</title>

<!-- Supabase v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root { --primary:#2c7be5; --primary-2:#1a5fcc; --ok:#28a745; --danger:#d9534f; --muted:#666; }
  *{box-sizing:border-box}
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:24px; }
  .wrap { max-width: 1000px; margin: 0 auto; }
  .card { background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); padding:18px; margin-bottom:16px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  .row > * { flex:1; min-width:220px; }
  label { font-weight:bold; font-size:13px; color:#333; display:block; margin-bottom:6px; }
  input[type="file"], input[type="text"], select { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
  button { padding:10px 14px; border:none; border-radius:8px; background:var(--primary); color:#fff; cursor:pointer; font-weight:bold; }
  button:hover { background:var(--primary-2); }
  .btn-sec { background:#6c757d; }
  .btn-sec:hover { background:#545b62; }
  .btn-danger { background:var(--danger); }
  .btn-danger:hover { background:#c33f3b; }
  .btn-ok { background:var(--ok); }
  .btn-ok:hover { background:#1e7e34; }
  .muted { color:var(--muted); font-size:12px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .user { font-size:14px; color:#333; }
  .sair { color:#c1121f; font-weight:bold; cursor:pointer; text-decoration:none; margin-left:8px; }
  .pill { padding:4px 10px; border-radius:999px; background:#eef2ff; font-size:12px; color:#1f3a8a; }
  .results { display:grid; grid-template-columns: 1fr; gap:10px; }
  .item { border:1px solid #eee; border-radius:10px; padding:12px; background:#fafafa; }
  .item .path { font-size:12px; color:#666; }
  .actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  .hint { font-size:12px; color:#555; margin-top:8px; }

  /* Modal Pastas */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal { width: 700px; max-width:95vw; background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
  .modal header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eee; }
  .modal header h3 { margin:0; font-size:16px; }
  .modal header button { background:transparent; color:#333; font-size:20px; padding:6px 10px; }
  .modal .body { padding:14px 16px; }
  .folders { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:10px; }
  .folder { border:1px solid #eee; border-radius:10px; padding:10px; display:flex; align-items:center; gap:10px; cursor:pointer; background:#fafafa; }
  .folder:hover { background:#f0f7ff; }
  .folder .name { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .folder .ops { display:flex; gap:6px; }
  .toolbar { display:flex; gap:8px; margin-bottom:10px; }
  .toolbar input { flex:1; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <strong>Gerenciador de Arquivos</strong>
      <span class="pill" id="guard-bucket"></span>
    </div>
    <div class="user">
      <span id="userEmail"></span>
      <a class="sair" onclick="logout()">sair</a>
    </div>
  </div>

  <!-- Upload -->
  <div class="card">
    <div class="row">
      <div>
        <label>Arquivo</label>
        <input type="file" id="fileInput" />
      </div>
      <div>
        <label>Pasta</label>
        <div class="row" style="gap:8px; align-items:center;">
          <input type="text" id="folderInput" placeholder="Ex.: Boletins/2025"/>
          <button class="btn-sec" onclick="abrirPastas()">Pastas</button>
        </div>
        <div class="muted">Digite o caminho (cria automaticamente) ou clique em <b>Pastas</b> para gerenciar/selecionar.</div>
      </div>
    </div>
    <div class="row" style="align-items:flex-end;">
      <div><button class="btn-ok" onclick="uploadFile()">Enviar</button></div>
    </div>
  </div>

  <!-- Busca -->
  <div class="card">
    <div class="row">
      <div>
        <label>Pesquisar (todas as pastas)</label>
        <input type="text" id="busca" placeholder="Qualquer termo do nome (ex.: nota, .pdf, foto)"/>
      </div>
      <div style="align-self:flex-end;">
        <button onclick="buscar()">Buscar</button>
      </div>
    </div>
    <div class="muted">Busca recursiva por todas as subpastas. Duplo clique numa pasta (na janela Pastas) filtra por aquela pasta.</div>
  </div>

  <!-- Resultados -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>Resultados</strong>
      <span class="muted" id="countInfo"></span>
    </div>
    <div id="resultados" class="results"></div>
  </div>
</div>

<!-- Modal Pastas -->
<div id="modalPastas" class="modal-backdrop" onclick="fecharPastas(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <header>
      <h3>Pastas ‚Äî Arquivos</h3>
      <button title="Fechar" onclick="fecharPastas()">‚úï</button>
    </header>
    <div class="body">
      <div class="toolbar">
        <input id="novaPasta" type="text" placeholder="Nova pasta (ex.: Boletins/2025)"/>
        <button class="btn-ok" onclick="criarPasta()">Criar</button>
      </div>
      <div class="muted" style="margin-bottom:8px;">Duplo clique em uma pasta para listar os arquivos dela. Use ‚úèÔ∏è para renomear e üóëÔ∏è para excluir.</div>
      <div id="listaPastas" class="folders"></div>
    </div>
  </div>
</div>

<script>
// --------- CONFIG ---------
const { createClient } = window.supabase;
const SUPABASE_URL  = "https://wnmtkoywbbzolbkoawva.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

// Bucket √∫nico
const BUCKET = "Arquivos"; // use exatamente como no Supabase
const EMAIL_PERMITIDO = "cearasementes@gmail.com";

document.getElementById("guard-bucket").textContent = `Bucket: ${BUCKET}`;

// Cache de estrutura
let foldersIndex = new Set(); // conjunto de pastas (prefixos) detectadas
let filesIndex = [];          // lista completa de arquivos (bucket/path)

// --------- AUTH GUARD ---------
async function ensureAuth() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;
  if (!session) { window.location.href = "index.html"; return; }
  const email = session.user?.email || "";
  if (email !== EMAIL_PERMITIDO) {
    alert("Acesso negado.");
    await supabase.auth.signOut();
    window.location.href = "index.html";
    return;
  }
  document.getElementById("userEmail").innerText = email;
}

async function logout() { await supabase.auth.signOut(); window.location.href = "index.html"; }

// --------- HELPERS ---------
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
function cleanPath(p){ return (p||"").replace(/^\/+|\/+$/g, ""); }

// Detecta se um item √© pasta tentando listar dentro
async function isFolder(prefix){
  const { data, error } = await supabase.storage.from(BUCKET).list(prefix, { limit:1 });
  return !error && Array.isArray(data);
}

// Lista recursivamente todas as pastas e arquivos
async function buildIndex(){
  foldersIndex.clear();
  filesIndex = [];
  // BFS
  const queue = [""];
  while(queue.length){
    const prefix = queue.shift();
    const { data: items } = await supabase.storage.from(BUCKET).list(prefix, { limit:1000, sortBy:{column:"name",order:"asc"} });
    if (!Array.isArray(items)) continue;
    for (const it of items){
      const name = it?.name || "";
      if (!name) continue;
      const sub = cleanPath(prefix ? `${prefix}/${name}` : name);
      // se conseguir listar dentro, tratamos como pasta
      const { data: probe } = await supabase.storage.from(BUCKET).list(sub, { limit:1 });
      if (Array.isArray(probe) && probe.length>=0){
        // Considera "pasta" se houver ao menos um item OU se existir arquivo marcador .init
        const hasContent = (probe && probe.length>0);
        if (hasContent) {
          foldersIndex.add(sub);
          queue.push(sub);
          continue;
        }
        // checa marcador
        const { data: probe2 } = await supabase.storage.from(BUCKET).list(sub, { search:".init", limit:1 });
        if (Array.isArray(probe2) && probe2.length>0){
          foldersIndex.add(sub);
          queue.push(sub);
          continue;
        }
      }
      // caso contr√°rio, √© arquivo na "prefix"
      filesIndex.push({ bucket: BUCKET, path: sub, name });
    }
  }
}

// --------- UPLOAD ---------
async function uploadFile(){
  const file = document.getElementById("fileInput").files[0];
  let folder = cleanPath(document.getElementById("folderInput").value);
  if (!file){ alert("Selecione um arquivo."); return; }
  const path = folder ? `${folder}/${file.name}` : file.name;
  const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert:true });
  if (error){ console.error(error); alert("Falha no upload. Verifique policies e nome do bucket."); return; }
  alert("Arquivo enviado.");
  await buildIndex();
  await listarArquivosDaPasta(folder || "");
}

// --------- BUSCA GLOBAL ---------
async function buscar(){
  const termo = (document.getElementById("busca").value||"").toLowerCase().trim();
  const resDiv = document.getElementById("resultados");
  const countInfo = document.getElementById("countInfo");
  resDiv.innerHTML = ""; countInfo.textContent = "";
  if (!filesIndex.length) await buildIndex();
  const match = filesIndex.filter(f => f.path.toLowerCase().includes(termo));
  if (!match.length){ resDiv.innerHTML = `<div class="muted">Nenhum arquivo encontrado.</div>`; return; }
  countInfo.textContent = `${match.length} arquivo(s)`;
  for (const it of match){ resDiv.appendChild(renderItem(it)); }
}

// --------- LISTAR ARQUIVOS DE UMA PASTA ---------
async function listarArquivosDaPasta(prefix){
  const resDiv = document.getElementById("resultados");
  const countInfo = document.getElementById("countInfo");
  resDiv.innerHTML = ""; countInfo.textContent = "";
  const { data: lista } = await supabase.storage.from(BUCKET).list(prefix, { limit:1000, sortBy:{column:"name", order:"asc"} });
  if (!Array.isArray(lista) || !lista.length){ resDiv.innerHTML = `<div class="muted">Sem arquivos nesta pasta.</div>`; return; }
  const files = [];
  for (const obj of lista){
    const name = obj?.name || "";
    const full = cleanPath(prefix ? `${prefix}/${name}` : name);
    // Se for subpasta, ignora aqui (a navega√ß√£o de pastas √© via modal)
    const { data: probe } = await supabase.storage.from(BUCKET).list(full, { limit:1 });
    if (Array.isArray(probe) && probe.length>0){ continue; }
    if (name === ".init") continue; // ignora marcador
    files.push({ bucket: BUCKET, path: full, name });
  }
  document.getElementById("folderInput").value = prefix;
  document.getElementById("busca").value = "";
  document.getElementById("countInfo").textContent = `${files.length} arquivo(s)`;
  for (const f of files){ resDiv.appendChild(renderItem(f)); }
}

function renderItem(it){
  const el = document.createElement("div");
  el.className = "item";
  el.innerHTML = `
    <div><strong>${escapeHtml(it.path.split("/").pop())}</strong></div>
    <div class="path">${escapeHtml(BUCKET)} / ${escapeHtml(it.path)}</div>
    <div class="actions">
      <button onclick="baixar('${encodeURIComponent(it.path)}')">Baixar</button>
      <button class="btn-sec" onclick="renomear('${encodeURIComponent(it.path)}')">Renomear</button>
      <button class="btn-sec" onclick="mover('${encodeURIComponent(it.path)}')">Mover</button>
      <button class="btn-danger" onclick="excluirArquivo('${encodeURIComponent(it.path)}')">Excluir</button>
    </div>`;
  return el;
}

// --------- A√á√ïES DE ARQUIVO ---------
async function baixar(pathEnc){
  const path = decodeURIComponent(pathEnc);
  const { data, error } = await supabase.storage.from(BUCKET).download(path);
  if (error){ alert("Falha no download."); return; }
  const url = URL.createObjectURL(data);
  const a = document.createElement("a"); a.href = url; a.download = path.split("/").pop();
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

async function excluirArquivo(pathEnc){
  const path = decodeURIComponent(pathEnc);
  if (!confirm(`Excluir definitivamente:
${BUCKET} / ${path} ?`)) return;
  const { error } = await supabase.storage.from(BUCKET).remove([path]);
  if (error){ alert("Falha ao excluir."); return; }
  alert("Exclu√≠do.");
  await buildIndex();
  const cur = cleanPath(document.getElementById("folderInput").value);
  await listarArquivosDaPasta(cur);
}

async function renomear(pathEnc){
  const oldPath = decodeURIComponent(pathEnc);
  const parts = oldPath.split("/");
  const oldName = parts.pop();
  const folder = parts.join("/");
  const novo = prompt("Novo nome do arquivo:", oldName);
  if (!novo || novo === oldName) return;
  const newPath = folder ? `${folder}/${novo}` : novo;
  const { error } = await supabase.storage.from(BUCKET).move(oldPath, newPath);
  if (error){ alert("Falha ao renomear."); return; }
  alert("Renomeado.");
  await buildIndex();
  await listarArquivosDaPasta(folder);
}

async function mover(pathEnc){
  const oldPath = decodeURIComponent(pathEnc);
  const fileName = oldPath.split("/").pop();
  const destino = prompt("Mover para qual pasta? (Ex.: Boletins/2025)", "");
  if (destino===null) return;
  const clean = cleanPath(destino);
  const newPath = clean ? `${clean}/${fileName}` : fileName;
  const { error } = await supabase.storage.from(BUCKET).move(oldPath, newPath);
  if (error){ alert("Falha ao mover o arquivo."); return; }
  alert("Movido.");
  await buildIndex();
  const cur = cleanPath(document.getElementById("folderInput").value);
  await listarArquivosDaPasta(cur);
}

// --------- MODAL PASTAS ---------
function abrirPastas(){ document.getElementById("modalPastas").style.display = "flex"; carregarPastas(); }
function fecharPastas(ev){ document.getElementById("modalPastas").style.display = "none"; }

async function carregarPastas(){
  if (!foldersIndex.size) await buildIndex();
  renderPastas(Array.from(foldersIndex).sort((a,b)=>a.localeCompare(b)));
}

function renderPastas(arr){
  const cont = document.getElementById("listaPastas");
  cont.innerHTML = "";
  if (!arr.length){ cont.innerHTML = `<div class="muted">Nenhuma pasta encontrada. Crie uma acima.</div>`; return; }
  for (const p of arr){
    const el = document.createElement("div");
    el.className = "folder";
    el.ondblclick = () => { document.getElementById("folderInput").value = p; fecharPastas(); listarArquivosDaPasta(p); };
    el.innerHTML = `
      <div style="font-size:18px">üìÅ</div>
      <div class="name" title="${escapeHtml(p)}">${escapeHtml(p)}</div>
      <div class="ops">
        <button class="btn-sec" title="Renomear" onclick="event.stopPropagation(); renomearPasta('${encodeURIComponent(p)}')">‚úèÔ∏è</button>
        <button class="btn-danger" title="Excluir" onclick="event.stopPropagation(); excluirPasta('${encodeURIComponent(p)}')">üóëÔ∏è</button>
      </div>`;
    cont.appendChild(el);
  }
}

async function criarPasta(){
  let nome = cleanPath(document.getElementById("novaPasta").value || "");
  if (!nome){ nome = prompt("Nome da nova pasta:", ""); nome = cleanPath(nome); }
  if (!nome) return;
  const fakePath = `${nome}/.init`;
  const { error } = await supabase.storage.from(BUCKET)
    .upload(fakePath, new Blob([""] , { type:"text/plain"}), { upsert:true });
  if (error){ alert("Falha ao criar pasta."); return; }
  document.getElementById("novaPasta").value = "";
  await buildIndex();
  carregarPastas();
}

async function excluirPasta(enc){
  const pasta = decodeURIComponent(enc);
  if (!confirm(`Excluir a pasta e todo o conte√∫do?
${pasta}`)) return;
  // listar tudo dentro e remover
  const toDelete = await listAllUnder(pasta);
  if (toDelete.length===0){
    // tentar remover marcador .init caso exista
    toDelete.push(`${pasta}/.init`);
  }
  const { error } = await supabase.storage.from(BUCKET).remove(toDelete);
  if (error){ alert("Falha ao excluir pasta."); return; }
  alert("Pasta exclu√≠da.");
  await buildIndex();
  carregarPastas();
  // se estava visualizando essa pasta, limpa lista
  const cur = cleanPath(document.getElementById("folderInput").value);
  if (cur === pasta){ document.getElementById("resultados").innerHTML = ""; document.getElementById("countInfo").textContent=""; }
}

async function renomearPasta(enc){
  const antiga = decodeURIComponent(enc);
  const nova = cleanPath(prompt("Novo nome da pasta:", antiga) || "");
  if (!nova || nova === antiga) return;
  // mover todos os itens de antiga/‚Ä¶ para nova/‚Ä¶
  const items = await listAllUnder(antiga);
  // cria marcador na nova
  await supabase.storage.from(BUCKET).upload(`${nova}/.init`, new Blob([""], {type:"text/plain"}), { upsert:true });
  for (const oldPath of items){
    const rest = oldPath.substring(antiga.length+1); // remove "antiga/"
    const newPath = `${nova}/${rest}`;
    await supabase.storage.from(BUCKET).move(oldPath, newPath);
  }
  // remove marcador antigo, se sobrar
  await supabase.storage.from(BUCKET).remove([`${antiga}/.init`]).catch(()=>{});
  alert("Pasta renomeada.");
  await buildIndex();
  carregarPastas();
  // se estava visualizando antiga, troca para nova
  const cur = cleanPath(document.getElementById("folderInput").value);
  if (cur === antiga){ document.getElementById("folderInput").value = nova; listarArquivosDaPasta(nova); }
}

// Lista recursivamente todos os caminhos dentro de um prefixo (pasta)
async function listAllUnder(prefix){
  const out = [];
  const queue = [prefix];
  while(queue.length){
    const p = queue.shift();
    const { data: items } = await supabase.storage.from(BUCKET).list(p, { limit:1000 });
    if (!Array.isArray(items)) continue;
    for (const it of items){
      const sub = cleanPath(`${p}/${it.name}`);
      // checa se √© subpasta
      const { data: probe } = await supabase.storage.from(BUCKET).list(sub, { limit:1 });
      if (Array.isArray(probe) && probe.length>0){ queue.push(sub); continue; }
      out.push(sub);
    }
  }
  return out.filter(x => x !== `${prefix}/.init`);
}

// --------- BOOT ---------
(async function boot(){
  await ensureAuth();
  await buildIndex();
  // Inicial: lista raiz (se quiser mudar, pode colocar uma pasta padr√£o)
  await listarArquivosDaPasta("");
})();
</script>
</body>
</html>
