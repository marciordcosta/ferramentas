<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gerenciador ‚Äì Lista + Pr√©-visualiza√ß√£o</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
    --border:#e5e7eb; --primary:#2563eb; --primary-2:#1e40af;
    --danger:#dc2626; --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  body{margin:0;background:var(--bg);color:var(--text);font-family:Segoe UI,Arial,sans-serif}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
  .brand{font-weight:700;font-size:18px;display:flex;align-items:center;gap:12px}
  .brand a{color:var(--primary);text-decoration:none;font-weight:600}
  .user a{color:var(--danger);cursor:pointer;text-decoration:none;margin-left:10px}

  .toolbar{display:flex;gap:10px;padding:14px;background:#fff;border-bottom:1px solid var(--border);align-items:center}
  .crumbs span{cursor:pointer;color:var(--primary)}
  .crumbs .sep{color:var(--muted)}

  input[type=text]{padding:10px 12px;border:1px solid var(--border);border-radius:10px;min-width:280px}
  button{cursor:pointer;border:1px solid var(--border);border-radius:10px;background:#e7e1e1;padding:6px 12px;display:flex;align-items:center;gap:4px}
  button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  button.primary:hover{background:var(--primary-2)}

  .icon{font-family:"Material Symbols Rounded";font-size:20px;vertical-align:middle}

  /* Autocomplete */
  .ac-wrap{position:relative}
  #acList{position:absolute;background:#fff;border:1px solid var(--border);border-radius:10px;width:100%;max-height:260px;overflow-y:auto;display:none;z-index:50;box-shadow:var(--shadow)}
  #acList .opt{padding:8px 10px;cursor:pointer;font-size:14px;display:flex;gap:8px;align-items:center}
  #acList .opt:hover{background:#eef2ff}
  #acList .path{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  main{display:flex;gap:16px;padding:16px}
  .left{flex:1}
  .right{width:520px;margin-top:-90px}

  .preview{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .preview .title{font-weight:700;margin-bottom:10px;font-size:17px}
  .preview .box{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .preview iframe.pdf{width:100%;height:640px;border:0}
  .preview img{max-width:100%;display:block}

  #view{display:block}
  .list-head,.list-row{display:grid;grid-template-columns:40px 1fr 120px 140px;gap:10px;align-items:center}
  .list-head{color:var(--muted);font-size:12px;margin-bottom:6px;padding:0 8px}
  .list-row{background:#fff;border:1px solid var(--border);border-radius:10px;padding:5px;margin-bottom:0px}
  .list-row .name{font-weight:600;font-size:13px}
  .actions span{cursor:pointer;padding:1px;border-radius:6px;font-size:20px}
  .actions span:hover{background:#f3f4f6}
  .actions .del{color:#b91c1c}

  /* Modal pastas */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{width:700px;max-width:95vw;background:#fff;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow)}
  .modal header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .folders-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;padding:12px}
  .folder-mini{display:flex;gap:8px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .folder-mini:hover{background:#f3f4f6}
</style>
</head>
<body>
<header>
  <div class="brand">Gerenciador <a href="index.html">¬∑ Voltar</a></div>
  <div class="user"><span id="userEmail"></span><a onclick="logout()">sair</a></div>
</header>

<div class="toolbar">
  <div id="breadcrumbs" class="crumbs"></div>
  <div class="ac-wrap" style="flex:1;max-width:360px">
    <input id="q" type="text" placeholder="Pesquisar (auto-complete)" oninput="onTypeSearch()" onkeydown="if(event.key==='Enter')buscar()"/>
    <div id="acList"></div>
  </div>
  <button onclick="buscar()"><span class="icon">search</span></button>
  <button class="primary" onclick="pickFiles()"><span class="icon">upload</span> Enviar</button>
  <input id="filePick" type="file" multiple style="display:none" />
</div>

<main>
  <div class="left">
    <div id="view"></div>
  </div>
  <aside class="right">
    <div class="preview">
      <div class="title">Pr√©-visualiza√ß√£o</div>
      <div class="meta" id="previewMeta">Selecione um arquivo</div>
      <div class="box" id="previewBox"><div style="padding:14px">Nenhum arquivo.</div></div>
      <div id="sendArea" style="margin-top:12px;display:none">
        <button onclick="sendWhatsApp()"><span class="icon">share</span> WhatsApp</button>
        <button onclick="sendEmail()"><span class="icon">mail</span> Email</button>
      </div>
    </div>
  </aside>
</main>

<!-- Modal Pastas -->
<div id="dlg" class="backdrop" onclick="closeDlg(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <header>
      <strong id="dlgTitle"></strong>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="newFolderName" type="text" placeholder="Nova pasta (ex.: Boletins/2025)"/>
        <button onclick="criarPastaFromDlg()"><span class="icon">create_new_folder</span> Adicionar</button>
        <button onclick="hideDlg()">‚úï</button>
      </div>
    </header>
    <div id="dlgFolders" class="folders-grid"></div>
  </div>
</div>

<script>
/* === CONFIG === */
const SUPABASE_URL = "https://wnmtkoywbbzolbkoawva.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk";
const OWNER_EMAIL = "cearasementes@gmail.com";
const BUCKET = "Arquivos";

const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentPath = "";
let uploadQueue = [];
let selectedFile = null;
let dlgMode = "pick"; // 'pick' upload | 'move' mover
let acIndex = []; let acTimer = null;

const el = s => document.querySelector(s);
const clean = p => (p||"").replace(/^\/+|\/+$/g, "");
function fmtSize(n){if(!n)return"-";const u=["B","KB","MB","GB"];let i=0;while(n>1024&&i<u.length-1){n/=1024;i++}return n.toFixed(1)+" "+u[i]}
function escapeHtml(s){return (s||"").replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}

/* === AUTH === */
async function ensureAuth(){
  const { data } = await supabase.auth.getSession();
  if(!data.session){ location.href = "index.html"; return; }
  const email = data.session.user?.email;
  if(email !== OWNER_EMAIL){ await supabase.auth.signOut(); location.href = "index.html"; return; }
  el('#userEmail').textContent = email;
}
function logout(){ supabase.auth.signOut().then(()=>location.href='index.html') }

/* === STORAGE HELPERS === */
async function listChildren(prefix){
  const { data } = await supabase.storage.from(BUCKET).list(prefix||'', { limit:2000, sortBy:{column:'name',order:'asc'} });
  const folders=[], files=[];
  for(const it of (data||[])){
    if(it.name === '.init') continue;
    const full = clean(prefix?`${prefix}/${it.name}`:it.name);
    if(it.metadata && typeof it.metadata.size === 'number') files.push({ name:it.name, full, size:it.metadata.size, date:it.updated_at||it.created_at||'' });
    else folders.push({ name:it.name, full });
  }
  return { folders, files };
}

/* === BREADCRUMB === */
function setCrumbs(){
  const bc = el('#breadcrumbs'); bc.innerHTML='';
  const root=document.createElement('span'); root.textContent='Arquivos'; root.onclick=()=>gotoFolder(''); bc.appendChild(root);
  if(!currentPath) return;
  let acc=''; currentPath.split('/').forEach(part=>{ acc = acc? acc+'/'+part : part; const sep=document.createElement('span'); sep.className='sep'; sep.textContent='‚Ä∫'; const seg=document.createElement('span'); seg.textContent=part; seg.onclick=()=>gotoFolder(acc); bc.appendChild(sep); bc.appendChild(seg); });
}

/* === RENDER === */
async function gotoFolder(prefix){ currentPath=clean(prefix||''); setCrumbs(); await render(); }

async function render(){
  const wrap = el('#view'); wrap.innerHTML='';
  const { folders, files } = await listChildren(currentPath);
  const head=document.createElement('div'); head.className='list-head'; head.innerHTML='<div></div><div>Nome</div><div>Tamanho</div><div>A√ß√µes</div>'; wrap.appendChild(head);
  folders.forEach(f=> wrap.appendChild(rowFolder(f)) );
  files.forEach(file=> wrap.appendChild(rowFile(file)) );

  // Pr√©-visualiza√ß√£o: escondida na raiz (s√≥ pastas)
  const pane = document.querySelector('aside.right');
  if(currentPath==='' && files.length===0){ pane.style.visibility='hidden'; pane.style.pointerEvents='none'; }
  else { pane.style.visibility='visible'; pane.style.pointerEvents='auto'; }

  setPreview(null);
}

/* === LINHAS === */
function rowFolder(f){
  const r=document.createElement('div'); r.className='list-row';
  r.innerHTML=`<div>üìÅ</div>
    <div><div class='name' style='cursor:pointer' onclick="gotoFolder('${f.full}')">${escapeHtml(f.name)}</div><div class='path'>${escapeHtml(f.full)}</div></div>
    <div>-</div>
    <div class='actions'>
      <span class='icon' title='Renomear' onclick="renameFolder('${f.full}')">edit</span>
      <span class='icon' title='Mover' onclick="openFolderPicker('move','${f.full}',true)">drive_file_move</span>
      <span class='icon del' title='Excluir' onclick="removeFolder('${f.full}')">delete</span>
    </div>`;
  return r;
}
function rowFile(file){
  const r=document.createElement('div'); r.className='list-row';
  r.onclick = ()=> setPreview(file);
  const folderPath = file.full.split('/').slice(0,-1).join('/');
  r.innerHTML=`<div>üìÑ</div>
    <div>
      <div class='name'>${escapeHtml(file.name)}</div>
      <div class='path'>${escapeHtml(folderPath)}</div>
    </div>
    <div>${fmtSize(file.size)}</div>
    <div class='actions'>
      <span class='icon' title='Baixar' onclick="event.stopPropagation(); downloadFile('${file.full}')">download</span>
      <span class='icon' title='Mover' onclick="event.stopPropagation(); openFolderPicker('move','${file.full}')">drive_file_move</span>
      <span class='icon' title='Renomear' onclick="event.stopPropagation(); renameFile('${file.full}')">edit</span>
      <span class='icon del' title='Excluir' onclick="event.stopPropagation(); deleteFile('${file.full}')">delete</span>
    </div>`;
  return r;
}

/* === PREVIEW === */
async function getSignedUrl(path){
  const { data, error } = await supabase.storage.from(BUCKET).createSignedUrl(path, 3600);
  if(error) return null; return data.signedUrl;
}

function setPreview(file){
  selectedFile = file;
  const meta = el('#previewMeta'); const box = el('#previewBox');
  const send = el('#sendArea');

  if(!file){ meta.textContent='Selecione um arquivo'; box.innerHTML='<div style="padding:14px">Nenhum arquivo.</div>'; send.style.display='none'; return; }

  meta.textContent = `${file.full} ‚Ä¢ ${fmtSize(file.size)}`;
  send.style.display='flex';

  const lower = file.name.toLowerCase();
  if(/\.(png|jpg|jpeg|gif|webp|bmp)$/i.test(lower)) return previewImage(file.full);
  if(/\.(pdf)$/i.test(lower)) return previewPDF(file.full);

  box.innerHTML = `<div style='padding:14px'>
    <div style='font-size:40px;margin-bottom:8px'>üìÑ</div>
    <div style='font-weight:600;margin-bottom:4px'>${escapeHtml(file.name)}</div>
    <div class='path'>${escapeHtml(file.full)}</div>
    <div class='path'>Tamanho: ${fmtSize(file.size)}</div>
  </div>`;
}

async function previewImage(path){
  const { data, error } = await supabase.storage.from(BUCKET).download(path);
  const box = el('#previewBox'); if(error){ box.innerHTML='<div style="padding:14px">Falha ao carregar imagem.</div>'; return; }
  const url = URL.createObjectURL(data); box.innerHTML = `<img src='${url}' alt='preview'/>`;
}
async function previewPDF(path){
  const { data, error } = await supabase.storage.from(BUCKET).download(path);
  const box = el('#previewBox'); if(error){ box.innerHTML='<div style="padding:14px">Falha ao carregar PDF.</div>'; return; }
  const url = URL.createObjectURL(data); box.innerHTML = `<iframe class='pdf' src='${url}'></iframe>`;
}

/* === ENVIAR === */
async function sendWhatsApp(){ if(!selectedFile) return; const url = await getSignedUrl(selectedFile.full); if(!url){ alert('N√£o foi poss√≠vel gerar link de compartilhamento.'); return; } const text = `Segue o arquivo: ${selectedFile.full}
${url}`; window.open(`https://wa.me/?text=${encodeURIComponent(text)}`,'_blank'); }
async function sendEmail(){ if(!selectedFile) return; const url = await getSignedUrl(selectedFile.full); if(!url){ alert('N√£o foi poss√≠vel gerar link de compartilhamento.'); return; } const subject = 'Envio de arquivo'; const body = `Segue o arquivo: ${selectedFile.full}
${url}`; window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; }

/* === A√á√ïES ARQUIVO === */
async function downloadFile(full){
  const { data, error } = await supabase.storage.from(BUCKET).download(full);
  if(error){ alert('Falha ao baixar.'); return; }
  const url = URL.createObjectURL(data); const a=document.createElement('a'); a.href=url; a.download=full.split('/').pop(); a.click(); URL.revokeObjectURL(url);
}
async function deleteFile(full){ if(!confirm('Excluir arquivo?')) return; const { error } = await supabase.storage.from(BUCKET).remove([full]); if(error){ alert('Falha ao excluir.'); return; } await render(); await rebuildIndex(); }
async function renameFile(full){ const parts=full.split('/'); const old=parts.pop(); const parent=parts.join('/'); const novo=prompt('Novo nome do arquivo:', old); if(!novo||novo===old) return; const { error } = await supabase.storage.from(BUCKET).move(full, `${parent?parent+'/':''}${novo}`); if(error){ alert('Falha ao renomear.'); return; } await render(); await rebuildIndex(); }

/* === A√á√ïES PASTA === */
async function renameFolder(full){ const parts=full.split('/'); const old=parts.pop(); const parent=parts.join('/'); const novo=prompt('Novo nome da pasta:', old); if(!novo||novo===old) return; const items=await listAllUnder(full); await supabase.storage.from(BUCKET).upload(`${parent?parent+'/':''}${novo}/.init`, new Blob(['']), {upsert:true}); for(const p of items){ const rest=p.slice(full.length+1); await supabase.storage.from(BUCKET).move(p, `${parent?parent+'/':''}${novo}/${rest}`); } await supabase.storage.from(BUCKET).remove([`${full}/.init`]).catch(()=>{}); await render(); await rebuildIndex(); }
async function removeFolder(full){ if(!confirm(`Excluir a pasta e todo o conte√∫do?
${full}`)) return; const items=await listAllUnder(full); if(items.length===0) items.push(`${full}/.init`); const { error } = await supabase.storage.from(BUCKET).remove(items); if(error){ alert('Falha ao excluir pasta.'); return; } await render(); await rebuildIndex(); }
async function listAllUnder(prefix){ const out=[], q=[prefix]; while(q.length){ const p=q.shift(); const { data }=await supabase.storage.from(BUCKET).list(p,{limit:2000}); for(const it of (data||[])){ if(it.name==='.init') continue; const full=clean(`${p}/${it.name}`); if(it.metadata && typeof it.metadata.size==='number') out.push(full); else q.push(full); } } return out; }

/* === UPLOAD / MOVER (MODAL) === */
function pickFiles(){ el('#filePick').click(); }
el('#filePick').addEventListener('change', e=>{ uploadQueue = Array.from(e.target.files||[]); openFolderPicker('pick'); });

function openFolderPicker(mode, sourceFull=null, isFolderMove=false){
  dlgMode=mode; el('#dlgTitle').textContent = mode==='pick' ? 'Selecionar pasta de destino' : (isFolderMove ? 'Mover conte√∫do da pasta‚Ä¶' : 'Mover arquivo para‚Ä¶');
  const dlg=el('#dlg'); dlg.style.display='flex'; dlg.dataset.source = sourceFull || ''; dlg.dataset.isFolderMove = isFolderMove ? '1':'0';
  loadDlgFolders();
}
function hideDlg(){ el('#dlg').style.display='none'; }
function closeDlg(e){ if(e.target.id==='dlg') hideDlg(); }

async function loadDlgFolders(){
  const grid=el('#dlgFolders'); grid.innerHTML='';
  const folders=await listAllFolders();
  folders.forEach(f=>{
    const d=document.createElement('div'); d.className='folder-mini';
    d.innerHTML=`<div>üìÅ</div><div style='flex:1;min-width:0'>${escapeHtml(f)}</div><div style='display:flex;gap:6px'><span class='icon' onclick="renameFolder('${f}')">edit</span><span class='icon del' onclick="removeFolder('${f}')">delete</span></div>`;
    d.ondblclick=()=> selectFolderForAction(f);
    grid.appendChild(d);
  });
}
async function listAllFolders(){
  const out=[]; async function scan(prefix){
    const { data }=await supabase.storage.from(BUCKET).list(prefix||'',{limit:2000,sortBy:{column:'name',order:'asc'}});
    for(const it of (data||[])){
      if(it.name==='.init') continue;
      if(!(it.metadata && typeof it.metadata.size==='number')){
        const full=clean(prefix?`${prefix}/${it.name}`:it.name);
        out.push(full); await scan(full);
      }
    }
  } await scan(''); return out;
}

async function selectFolderForAction(dest){
  const dlg=el('#dlg'); const src=dlg.dataset.source||''; const isFolderMove = dlg.dataset.isFolderMove==='1';
  if(dlgMode==='pick'){ await doUploadTo(dest); }
  else { if(isFolderMove) await moveFolderContents(src,dest); else await doMoveFileTo(src,dest); }
  hideDlg();
}
async function doUploadTo(dest){
  if(!uploadQueue.length) return;
  for(const file of uploadQueue){
    const path=`${dest}/${file.name}`;
    const { error } = await supabase.storage.from(BUCKET).upload(path,file,{upsert:true});
    if(error){ alert('Falha no upload em '+path); return; }
  }
  uploadQueue=[]; el('#filePick').value='';
  if(clean(dest)===clean(currentPath)) await render();
  await rebuildIndex();
  alert('Upload conclu√≠do.');
}
async function doMoveFileTo(from,dest){
  if(!from) return;
  const name=from.split('/').pop();
  const to=`${dest}/${name}`;
  const { error } = await supabase.storage.from(BUCKET).move(from,to);
  if(error){ alert('Falha ao mover.'); return; }
  await render();
  await rebuildIndex();
  alert('Movido.');
}
async function moveFolderContents(fromFolder,destFolder){
  const items=await listAllUnder(fromFolder);
  for(const p of items){
    const name=p.split('/').pop();
    const to=`${destFolder}/${name}`;
    const { error }=await supabase.storage.from(BUCKET).move(p,to);
    if(error){ alert('Falha ao mover algum item.'); return; }
  }
  await render();
  await rebuildIndex();
  alert('Conte√∫do movido.');
}
async function criarPastaFromDlg(){
  const name=clean(el('#newFolderName').value);
  if(!name) return;
  await supabase.storage.from(BUCKET).upload(`${name}/.init`, new Blob(['']), {upsert:true});
  el('#newFolderName').value='';
  await loadDlgFolders(); await render(); await rebuildIndex();
}

/* === BUSCA + AUTOCOMPLETE === */
async function rebuildIndex(){
  const out=[]; async function scan(prefix){
    const { data }=await supabase.storage.from(BUCKET).list(prefix||'',{limit:2000});
    for(const it of (data||[])){
      if(it.name==='.init') continue;
      const full=clean(prefix?`${prefix}/${it.name}`:it.name);
      if(it.metadata && typeof it.metadata.size==='number'){ out.push({name:it.name, full}); }
      else { await scan(full); }
    }
  } await scan(''); acIndex = out;
}
function onTypeSearch(){ clearTimeout(acTimer); acTimer = setTimeout(showAutocomplete, 150); }
function showAutocomplete(){
  const term=(el('#q').value||'').trim().toLowerCase(); const box=el('#acList');
  if(!term){ box.style.display='none'; box.innerHTML=''; return; }
  if(!acIndex.length){ rebuildIndex().then(showAutocomplete); return; }
  const results = acIndex.filter(x=>x.full.toLowerCase().includes(term)).slice(0,12);
  if(!results.length){ box.style.display='none'; box.innerHTML=''; return; }
  box.innerHTML = results.map(r=>`<div class='opt' onclick="acPick('${encodeURIComponent(r.full)}')">üìÑ <div style='min-width:0'><div>${escapeHtml(r.name)}</div><div class='path'>${escapeHtml(r.full)}</div></div></div>`).join('');
  box.style.display='block';
}
function acPick(encFull){
  const full=decodeURIComponent(encFull);
  const folder = full.split('/').slice(0,-1).join('/');
  el('#q').value = full.split('/').pop();
  el('#acList').style.display='none';
  gotoFolder(folder).then(async()=>{
    const { files } = await listChildren(folder);
    const match = files.find(f=>f.full===full);
    if(match) setPreview(match);
  });
}
async function buscar(){
  const term=(el('#q').value||'').trim().toLowerCase();
  if(!term){ alert('Digite algo para buscar.'); return; }
  if(!acIndex.length) await rebuildIndex();
  const hits = acIndex.filter(x=>x.full.toLowerCase().includes(term));
  const wrap=el('#view'); wrap.innerHTML='';
  const head=document.createElement('div'); head.className='list-head';
  head.innerHTML='<div></div><div>Nome</div><div>Tamanho</div><div>A√ß√µes</div>'; wrap.appendChild(head);
  for(const h of hits){
    const parts=h.full.split('/'); const folder=parts.slice(0,-1).join('/'); const name=parts.pop();
    const { data } = await supabase.storage.from(BUCKET).list(folder,{limit:2000});
    const item = (data||[]).find(x=>x.name===name);
    const size = item?.metadata?.size||0;
    const file={ name, full:h.full, size };
    wrap.appendChild(rowFile(file));
  }
  setPreview(null);
}

/* === BOOT === */
(async function(){
  await ensureAuth();
  await gotoFolder('');
  await rebuildIndex();
})();
</script>

</body>
</html>







