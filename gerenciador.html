<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gerenciador de Arquivos</title>

<!-- Supabase v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:24px; }
  .wrap { max-width: 900px; margin: 0 auto; }
  .card { background:#fff; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); padding:18px; margin-bottom:16px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  .row > * { flex:1; min-width:220px; }
  label { font-weight:bold; font-size:13px; color:#333; display:block; margin-bottom:6px; }
  input[type="file"], input[type="text"], select { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
  button { padding:10px 14px; border:none; border-radius:8px; background:#2c7be5; color:#fff; cursor:pointer; font-weight:bold; }
  button:hover { background:#1a5fcc; }
  .btn-sec { background:#6c757d; }
  .btn-sec:hover { background:#545b62; }
  .btn-danger { background:#d9534f; }
  .btn-danger:hover { background:#c33f3b; }
  .btn-ok { background:#28a745; }
  .btn-ok:hover { background:#1e7e34; }
  .muted { color:#666; font-size:12px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .user { font-size:14px; color:#333; }
  .sair { color:#c1121f; font-weight:bold; cursor:pointer; text-decoration:none; margin-left:8px; }
  .pill { padding:4px 10px; border-radius:999px; background:#eef2ff; font-size:12px; color:#1f3a8a; }
  .results { display:grid; grid-template-columns: 1fr; gap:10px; }
  .item { border:1px solid #eee; border-radius:10px; padding:12px; background:#fafafa; }
  .item .path { font-size:12px; color:#666; }
  .actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  .hint { font-size:12px; color:#555; margin-top:8px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <strong>Gerenciador de Arquivos</strong>
      <span class="pill" id="guard-buckets"></span>
    </div>
    <div class="user">
      <span id="userEmail"></span>
      <a class="sair" onclick="logout()">sair</a>
    </div>
  </div>

  <!-- Upload -->
  <div class="card">
    <div class="row">
      <div>
        <label>Arquivo</label>
        <input type="file" id="fileInput" />
      </div>
      <div>
        <label>Bucket</label>
        <select id="bucketSelect"></select>
      </div>
      <div>
        <label>Pasta (crie ou escolha)</label>
        <div class="row" style="gap:8px;">
          <input type="text" id="folderInput" placeholder="Ex.: 2025, boletim-nov, fotos-campo"/>
          <button class="btn-sec" onclick="sugerirPastas()">Sugerir</button>
        </div>
        <div class="muted">Digite um nome novo para criar a pasta automaticamente no upload, ou clique em “Sugerir” para listar pastas existentes.</div>
        <div id="foldersSuggestions" class="hint"></div>
      </div>
    </div>
    <div class="row" style="align-items:flex-end;">
      <div><button class="btn-ok" onclick="uploadFile()">Enviar</button></div>
    </div>
  </div>

  <!-- Busca -->
  <div class="card">
    <div class="row">
      <div>
        <label>Pesquisar (em todos os buckets e pastas)</label>
        <input type="text" id="busca" placeholder="Digite parte do nome (ex.: nota, foto, .pdf)"/>
      </div>
      <div style="align-self:flex-end;">
        <button onclick="buscar()">Buscar</button>
      </div>
    </div>
    <div class="muted">A busca faz varredura por pastas conhecidas em cada bucket. Use “Sugerir” para atualizar a lista de pastas de um bucket antes da busca, caso tenha criado pastas novas recentemente.</div>
  </div>

  <!-- Resultados -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>Resultados</strong>
      <span class="muted" id="countInfo"></span>
    </div>
    <div id="resultados" class="results"></div>
  </div>
</div>

<script>
// --------- CONFIG ---------
const { createClient } = window.supabase;
const SUPABASE_URL  = "https://wnmtkoywbbzolbkoawva.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXRrb3l3YmJ6b2xia29hd3ZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ2NzgsImV4cCI6MjA3NzkxMDY3OH0.-FQZhh8Kbugfv4Dl-vAZXKcVnfzJXG1HK45PRkGmDmk";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

// ATENÇÃO: use exatamente os nomes dos buckets criados no Supabase.
const BUCKETS = ["Arquivos"];

// e-mail único autorizado
const EMAIL_PERMITIDO = "cearasementes@gmail.com";

// cache simples de pastas por bucket
const foldersCache = new Map(); // bucket -> Set(folders)

// --------- AUTH GUARD ---------
async function ensureAuth() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;
  if (!session) { window.location.href = "index.html"; return; }
  const email = session.user?.email || "";
  if (email !== EMAIL_PERMITIDO) {
    alert("Acesso negado.");
    await supabase.auth.signOut();
    window.location.href = "index.html";
    return;
  }
  document.getElementById("userEmail").innerText = email;
}

// --------- UI INIT ---------
function initUI() {
  const sel = document.getElementById("bucketSelect");
  sel.innerHTML = "";
  BUCKETS.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b; opt.textContent = b;
    sel.appendChild(opt);
  });
  document.getElementById("guard-buckets").textContent = `Buckets: ${BUCKETS.join(" • ")}`;
}

// --------- FOLDERS SUGGESTIONS ---------
// Tenta descobrir pastas top-level de um bucket listando a raiz e pegando itens
// que se comportam como diretórios (tentativa de listagem recursiva).
async function listarPastasBucket(bucket) {
  const known = new Set(foldersCache.get(bucket) || []);
  try {
    // lista raiz do bucket
    const { data: root } = await supabase.storage.from(bucket).list("", { limit: 1000, sortBy: { column: "name", order: "asc" }});
    if (Array.isArray(root)) {
      // tenta detectar subpastas testando listagem de cada nome como prefixo
      for (const item of root) {
        const name = (item?.name || "").trim();
        if (!name) continue;
        // se conseguir listar algo dentro, tratamos como pasta
        const { data: probe, error: probeErr } = await supabase.storage.from(bucket).list(name, { limit: 1 });
        if (!probeErr) {
          known.add(name);
        }
      }
    }
  } catch(e) {
    console.warn("Falha ao listar pastas do bucket", bucket, e);
  }
  foldersCache.set(bucket, known);
  return Array.from(known).sort((a,b)=>a.localeCompare(b));
}

async function sugerirPastas() {
  const bucket = document.getElementById("bucketSelect").value;
  const list = await listarPastasBucket(bucket);
  const cont = document.getElementById("foldersSuggestions");
  if (!list.length) {
    cont.innerHTML = `<span class="muted">Nenhuma pasta encontrada neste bucket. Crie digitando um nome no campo acima.</span>`;
    return;
  }
  cont.innerHTML = list.map(f => `<a href="#" onclick="pickFolder('${encodeURIComponent(f)}');return false;">${escapeHtml(f)}</a>`).join(" • ");
}

function pickFolder(encoded) {
  const name = decodeURIComponent(encoded);
  document.getElementById("folderInput").value = name;
}

// --------- UPLOAD ---------
async function uploadFile() {
  const file = document.getElementById("fileInput").files[0];
  const bucket = document.getElementById("bucketSelect").value;
  let folder = (document.getElementById("folderInput").value || "").trim();

  if (!file) { alert("Selecione um arquivo."); return; }
  if (!bucket) { alert("Selecione o bucket."); return; }

  // normaliza pasta (opcional)
  if (folder.startsWith("/")) folder = folder.slice(1);
  if (folder.endsWith("/")) folder = folder.slice(0,-1);

  const path = folder ? `${folder}/${file.name}` : file.name;

  const { error } = await supabase.storage.from(bucket).upload(path, file, { upsert: true });
  if (error) {
    console.error(error);
    alert("Falha no upload. Verifique as policies e o nome exato do bucket.");
    return;
  }

  // atualiza cache da pasta
  if (folder) {
    const set = foldersCache.get(bucket) || new Set();
    set.add(folder);
    foldersCache.set(bucket, set);
  }

  alert("Arquivo enviado com sucesso.");
}

// --------- BUSCA (varre pastas conhecidas dos dois buckets) ---------
async function buscar() {
  const termo = (document.getElementById("busca").value || "").toLowerCase().trim();
  const resDiv = document.getElementById("resultados");
  const countInfo = document.getElementById("countInfo");
  resDiv.innerHTML = "";
  countInfo.textContent = "";

  let encontrados = [];

  for (const bucket of BUCKETS) {
    // garante que temos pastas conhecidas (raiz inclusive)
    const known = new Set(foldersCache.get(bucket) || []);
    // sempre tenta raiz também
    known.add("");

    if (!known.size) {
      await listarPastasBucket(bucket);
    }

    for (const folder of known) {
      const { data: lista } = await supabase.storage.from(bucket).list(folder, { limit: 1000, sortBy: { column:"name", order:"asc" }});
      if (!Array.isArray(lista)) continue;

      for (const obj of lista) {
        // ignora “itens” que sejam subpastas (vamos considerar arquivo quando tiver size > 0 ou metadata presente)
        const name = obj?.name || "";
        // filtra por termo
        if (!termo || name.toLowerCase().includes(termo)) {
          // monta caminho completo
          const fullPath = folder ? `${folder}/${name}` : name;
          // empilha
          encontrados.push({ bucket, path: fullPath, name, folder });
        }
      }
    }
  }

  // apresenta
  if (!encontrados.length) {
    resDiv.innerHTML = `<div class="muted">Nenhum arquivo encontrado.</div>`;
    return;
  }

  countInfo.textContent = `${encontrados.length} arquivo(s)`;
  for (const it of encontrados) {
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div><strong>${escapeHtml(it.name)}</strong></div>
      <div class="path">${escapeHtml(it.bucket)} / ${escapeHtml(it.path)}</div>
      <div class="actions">
        <button onclick="baixar('${encodeURIComponent(it.bucket)}','${encodeURIComponent(it.path)}')">Baixar</button>
        <button class="btn-sec" onclick="renomear('${encodeURIComponent(it.bucket)}','${encodeURIComponent(it.path)}')">Renomear</button>
        <button class="btn-sec" onclick="mover('${encodeURIComponent(it.bucket)}','${encodeURIComponent(it.path)}')">Mover</button>
        <button class="btn-danger" onclick="excluirArquivo('${encodeURIComponent(it.bucket)}','${encodeURIComponent(it.path)}')">Excluir</button>
      </div>
    `;
    resDiv.appendChild(el);
  }
}

// --------- AÇÕES ---------
async function baixar(bucketEnc, pathEnc) {
  const bucket = decodeURIComponent(bucketEnc);
  const path = decodeURIComponent(pathEnc);
  const { data, error } = await supabase.storage.from(bucket).download(path);
  if (error) { alert("Falha no download."); return; }
  const url = URL.createObjectURL(data);
  const a = document.createElement("a");
  a.href = url;
  a.download = path.split("/").pop();
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function excluirArquivo(bucketEnc, pathEnc) {
  const bucket = decodeURIComponent(bucketEnc);
  const path = decodeURIComponent(pathEnc);
  if (!confirm(`Excluir definitivamente:\n${bucket} / ${path} ?`)) return;
  const { error } = await supabase.storage.from(bucket).remove([path]);
  if (error) { alert("Falha ao excluir."); return; }
  alert("Excluído.");
  buscar();
}

async function renomear(bucketEnc, pathEnc) {
  const bucket = decodeURIComponent(bucketEnc);
  const path = decodeURIComponent(pathEnc);
  const parts = path.split("/");
  const oldName = parts.pop();
  const folder = parts.join("/");

  const novo = prompt("Novo nome do arquivo:", oldName);
  if (!novo || novo === oldName) return;

  const newPath = folder ? `${folder}/${novo}` : novo;

  // usar move dentro do mesmo bucket
  const { error } = await supabase.storage.from(bucket).move(path, newPath);
  if (error) { alert("Falha ao renomear."); return; }
  alert("Renomeado.");
  buscar();
}

async function mover(bucketEnc, pathEnc) {
  const bucket = decodeURIComponent(bucketEnc);
  const path = decodeURIComponent(pathEnc);
  const fileName = path.split("/").pop();

  const novaPasta = prompt("Mover para qual pasta? (Ex: Boletins/2025)", "");
  if (novaPasta === null) return;

  const clean = novaPasta.replace(/^\/+|\/+$/g, "");
  const newPath = clean ? `${clean}/${fileName}` : fileName;

  const { error } = await supabase.storage.from(bucket).move(path, newPath);
  if (error) {
    alert("Falha ao mover o arquivo.");
    return;
  }

  alert("Arquivo movido com sucesso.");
  buscar();
}

// --------- SESSÃO ---------
async function logout() {
  await supabase.auth.signOut();
  window.location.href = "index.html";
}

// --------- HELPERS ---------
function escapeHtml(s) {
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

// --------- BOOT ---------
(async function boot(){
  await ensureAuth();
  initUI();
  // carrega sugestões iniciais de pastas dos dois buckets (assíncrono)
  for (const b of BUCKETS) { listarPastasBucket(b).catch(()=>{}); }
})();
</script>
</body>
</html>


