<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Frete</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f5f5f5;margin:0;padding:20px;display:flex;justify-content:center}
.box{background:#fff;padding:25px;border-radius:10px;width:100%;max-width:500px;box-shadow:0 2px 6px rgba(0,0,0,0.15)}
input,select,button{padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:5px;font-size:15px}
input,select{width:100%}
.busca-cep-linha{display:flex;gap:8px;align-items:center}
.busca-cep-linha input{flex:1}
button{background:#1e65d4;color:#fff;border:none;cursor:pointer}
button:hover{background:#154a9a}
.resultado{margin-top:20px;padding:15px;background:#eee;border-radius:6px}
.melhor{background:#c8f7c5;padding:6px;border-radius:4px;margin-bottom:6px}

.autocomplete-items{position:absolute;border:1px solid #d4d4d4;border-top:none;z-index:99;top:100%;left:0;right:0;background:#fff;max-height:180px;overflow-y:auto}
.autocomplete-items div{padding:10px;cursor:pointer;border-bottom:1px solid #d4d4d4}
.autocomplete-active{background:#1e65d4;color:#fff}
</style>
</head>
<body>

<div class="box">
    <h3>Calcular Frete</h3>

    <!-- BUSCA POR CIDADE PRIMEIRO -->
    <div style="position:relative;">
        <label>Cidade</label>
        <input type="text" id="cidade" placeholder="Digite a cidade">
    </div>

    <!-- AGORA O CEP -->
    <label>CEP</label>
    <div class="busca-cep-linha">
        <input type="text" id="cep" placeholder="60010-000" maxlength="9" oninput="mascaraCEP(this)">
        <button onclick="buscarCEP()">Buscar</button>
    </div>

    <label>Peso (kg)</label>
    <input type="number" id="peso" step="0.01">

    <label>Valor da mercadoria (R$)</label>
    <input type="number" id="valor" step="0.01">

    <label>Ordenar por</label>
    <select id="ordenar">
        <option value="prazo">Menor prazo</option>
        <option value="valor">Menor frete</option>
    </select>

    <button onclick="calcularFrete()">Calcular</button>

    <div id="resultado" class="resultado"></div>
</div>

<script src="dados.js"></script>

<script>
// =========================
// MÁSCARA CEP
// =========================
function mascaraCEP(input){
    input.value = input.value.replace(/\D/g,"")
                             .replace(/(\d{5})(\d)/,"$1-$2")
                             .slice(0,9);
}

// =========================
// CONSULTA CEP
// =========================
async function buscarCEP(){
    const cep = document.getElementById("cep").value.replace(/\D/g,"");
    if(cep.length !== 8){
        alert("CEP inválido");
        return;
    }

    const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const data = await r.json();

    if(data.erro){
        alert("CEP não encontrado");
        return;
    }

    // Preenche cidade e salva UF
    document.getElementById("cidade").value = data.localidade;
    window.__UF_SELECIONADA = data.uf;
}

// =========================
// NORMALIZAÇÃO DO PRAZO
// =========================
function getPrazoMeta(entry){
    if(entry == null) return null;

    if(typeof entry === "number" || typeof entry === "string"){
        return { prazo: entry, uf:null, cep_inicio:null, cep_fim:null };
    }

    return {
        prazo: entry.prazo,
        uf: entry.uf || null,
        cep_inicio: entry.cep_inicio || null,
        cep_fim: entry.cep_fim || null
    };
}

// =========================
// AUTOCOMPLETE
// =========================
function setupAutocomplete(inp, arr){
    let currentFocus;

    inp.addEventListener("input", function(){
        const val = this.value.trim();
        closeAllLists();
        if(!val) return;

        currentFocus = -1;

        const list = document.createElement("DIV");
        list.setAttribute("id", this.id + "-autocomplete-list");
        list.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(list);

        arr.forEach(c=>{
            if(c.substr(0,val.length).toLowerCase() === val.toLowerCase()){
                const item = document.createElement("DIV");
                item.innerHTML = "<strong>"+c.substr(0,val.length)+"</strong>"+c.substr(val.length);
                item.innerHTML += "<input type='hidden' value='"+c+"'>";
                item.onclick = function(){
                    inp.value = this.getElementsByTagName("input")[0].value;
                    closeAllLists();
                };
                list.appendChild(item);
            }
        });
    });

    inp.addEventListener("keydown", function(e){
        let x = document.getElementById(this.id + "-autocomplete-list");
        if(x) x = x.getElementsByTagName("DIV");

        if(e.keyCode == 40){
            currentFocus++;
            addActive(x);
        } else if(e.keyCode == 38){
            currentFocus--;
            addActive(x);
        } else if(e.keyCode == 13){
            e.preventDefault();
            if(currentFocus > -1 && x) x[currentFocus].click();
        }
    });

    function addActive(x){
        if(!x) return;
        removeActive(x);
        if(currentFocus >= x.length) currentFocus = 0;
        if(currentFocus < 0) currentFocus = x.length - 1;
        x[currentFocus].classList.add("autocomplete-active");
    }
    function removeActive(x){
        for(let i=0;i<x.length;i++) x[i].classList.remove("autocomplete-active");
    }
    function closeAllLists(elmnt){
        const items = document.getElementsByClassName("autocomplete-items");
        for(let i=0;i<items.length;i++){
            if(elmnt != items[i] && elmnt != inp){
                items[i].parentNode.removeChild(items[i]);
            }
        }
    }
    document.addEventListener("click", function(e){
        closeAllLists(e.target);
    });
}

// =========================
// INICIALIZA AUTOCOMPLETE
// =========================
function inicializar(){
    const todas = new Set();
    window.DADOS_FRETE.transportadoras.forEach(t=>{
        Object.keys(t.prazos).forEach(c=>todas.add(c));
    });
    const lista = Array.from(todas).sort();
    setupAutocomplete(document.getElementById("cidade"), lista);
}
inicializar();

// =========================
// CALCULAR FRETE
// =========================
function calcularFrete(){
    const cidade = document.getElementById("cidade").value.trim();
    const peso = parseFloat(document.getElementById("peso").value);
    const valor = parseFloat(document.getElementById("valor").value);
    const ordenar = document.getElementById("ordenar").value;
    const ufSelecionada = window.__UF_SELECIONADA || null;

    if(!cidade || isNaN(peso) || isNaN(valor)){
        alert("Preencha tudo");
        return;
    }

    let opcoes = [];

    window.DADOS_FRETE.transportadoras.forEach(t=>{
        const raw = (t.prazos || {})[cidade];
        const meta = getPrazoMeta(raw);
        if(!meta) return;

        if(meta.uf && ufSelecionada && meta.uf !== ufSelecionada) return;

        const valorNF = t.valorPorNF <= 1 ? t.valorPorNF * valor : t.valorPorNF;
        const taxaColeta = t.taxaColeta <= 1 ? t.taxaColeta * valor : t.taxaColeta;

        let frete = (t.valorPorKg * peso) + valorNF + taxaColeta;
        if(t.freteMinimo && frete < t.freteMinimo) frete = t.freteMinimo;

        opcoes.push({
            nome:t.nome,
            prazoCidade:meta.prazo,
            cep_inicio:meta.cep_inicio,
            cep_fim:meta.cep_fim,
            freteTotal:frete
        });
    });

    const res = document.getElementById("resultado");

    if(opcoes.length === 0){
        res.innerHTML = "<strong>Cidade não encontrada.</strong>";
        return;
    }

    if(ordenar === "prazo"){
        opcoes.sort((a,b)=>Number(a.prazoCidade) - Number(b.prazoCidade));
    }else{
        opcoes.sort((a,b)=>a.freteTotal - b.freteTotal);
    }

    let html = "<h3>Resultado</h3>";

    opcoes.slice(0,3).forEach((t,i)=>{
        const faixa = (t.cep_inicio && t.cep_fim)
            ? ` — CEP ${t.cep_inicio} a ${t.cep_fim}` : "";

        html += `
        <div class="${i===0?'melhor':''}">
            <strong>${t.nome}</strong> —
            Prazo: ${t.prazoCidade}h úteis${faixa} —
            R$ ${t.freteTotal.toFixed(2)}
        </div>`;
    });

    res.innerHTML = html;
}
</script>

</body>
</html>
