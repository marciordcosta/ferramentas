<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Frete</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
    margin: 0;
}

.container {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    max-width: 600px;
    width: 95%;
}

/* Inputs */
input, select {
    width: 100%;
    padding: 10px;
    margin: 5px 0 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
}

/* Cidade + UF lado a lado */
.row {
    display: flex;
    gap: 10px;
}

.row .small {
    width: 80px;
}

/* Buttons */
button {
    padding: 10px 15px;
    font-size: 14px;
    border: none;
    border-radius: 6px;
    background: #2c7be5;
    color: white;
    cursor: pointer;
}

button:hover {
    background: #1a5fcc;
}

.resultado {
    margin-top: 20px;
    padding: 10px;
    background: #f3f3f3;
    border-radius: 6px;
}

.melhor {
    background-color: #d1f7c4;
    padding: 5px;
    border-radius: 4px;
    margin-bottom: 5px;
}

/* Autocomplete */
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 99;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background-color: #fff;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #d4d4d4;
}

.autocomplete-active {
  background-color:#2c7be5 !important;
  color: #fff;
}

</style>
</head>

<body>

<div class="container">
  <h2>Cotação de Frete</h2>

  <!-- CIDADE + UF -->
  <div class="row" style="position:relative;">
      <div style="flex:1">
          <label for="cidade">Cidade</label>
          <input type="text" id="cidade" placeholder="Digite a cidade">
      </div>

      <div class="small">
          <label for="uf">UF</label>
          <input type="text" id="uf" disabled>
      </div>
  </div>

  <!-- CEP -->
  <div class="row">
      <div style="flex:1; position:relative;">
          <label for="cep">Buscar por CEP</label>
          <input type="text" id="cep" placeholder="Ex: 62000000">
      </div>

      <button style="margin-top:22px;" onclick="buscarCEP()">Buscar</button>
  </div>

  <label for="peso">Peso total (kg)</label>
  <input type="number" id="peso" placeholder="Ex: 100" step="0.01">

  <label for="valor">Valor da mercadoria (R$)</label>
  <input type="number" id="valor" placeholder="Ex: 150.00" step="0.01">

  <label for="ordenar">Ordenar por</label>
  <select id="ordenar">
    <option value="prazo">Menor Prazo</option>
    <option value="valor">Menor Frete</option>
  </select>

  <button onclick="calcularFrete()">Calcular</button>
  <button onclick="limparTudo()" style="background:#777; margin-left:5px;">Limpar</button>

  <div class="resultado" id="resultado"></div>
</div>

<!-- ✅ DADOS EXTERNOS -->
<script src="dados.js"></script>

<script>
// ===============================
//   AUTOCOMPLETE DA CIDADE
// ===============================
function setupAutocomplete(inp, arr) {
  let currentFocus;

  inp.addEventListener("input", function () {
    const val = this.value.trim();
    closeAllLists();

    if (!val) return;

    const list = document.createElement("div");
    list.setAttribute("id", this.id + "-autocomplete-list");
    list.setAttribute("class", "autocomplete-items");
    this.parentNode.appendChild(list);

    arr.forEach(item => {
      if (item.nome.substr(0, val.length).toUpperCase() === val.toUpperCase()) {
        const itemDiv = document.createElement("div");

        itemDiv.innerHTML =
          "<strong>" + item.nome.substr(0, val.length) + "</strong>" +
          item.nome.substr(val.length);

        itemDiv.innerHTML += "<input type='hidden' value='" + item.nome + "'>";
        itemDiv.addEventListener("click", function () {

          inp.value = item.nome;
          document.getElementById("uf").value = item.uf;
          window.__UF_SELECIONADA = item.uf;

          closeAllLists();
        });

        list.appendChild(itemDiv);
      }
    });
  });

  function closeAllLists(elmnt) {
    const items = document.getElementsByClassName("autocomplete-items");
    for (let i = 0; i < items.length; i++) {
      if (elmnt != items[i] && elmnt != inp) items[i].remove();
    }
  }

  document.addEventListener("click", e => closeAllLists(e.target));
}

// Monta lista de cidades do JSON
const LISTA_CIDADES = [];
DADOS_FRETE.transportadoras.forEach(t => {
  Object.keys(t.prazos).forEach(cidade => {
    LISTA_CIDADES.push({
      nome: cidade,
      uf: t.prazos[cidade].uf
    });
  });
});

setupAutocomplete(document.getElementById("cidade"), LISTA_CIDADES);

// ===============================
// BUSCAR CEP (ViaCEP)
// ===============================
async function buscarCEP() {
  const cep = document.getElementById("cep").value.replace(/\D/g, "");

  if (cep.length !== 8) {
    alert("CEP inválido");
    return;
  }

  const url = `https://viacep.com.br/ws/${cep}/json/`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();

    if (data.erro) {
      document.getElementById("resultado").innerHTML = "CEP não encontrado.";
      return;
    }

    const cidade = data.localidade;
    const uf = data.uf;

    document.getElementById("cidade").value = cidade;
    document.getElementById("uf").value = uf;

    window.__UF_SELECIONADA = uf;

  } catch {
    document.getElementById("resultado").innerHTML = "Falha ao consultar CEP.";
  }
}

// ===============================
//   CALCULAR FRETE
// ===============================
function calcularFrete() {

  const cidade = document.getElementById("cidade").value.trim();
  const peso = parseFloat(document.getElementById("peso").value);
  const valor = parseFloat(document.getElementById("valor").value);
  const ordenar = document.getElementById("ordenar").value;

  if (!cidade || isNaN(peso) || isNaN(valor)) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  let opcoes = [];

  DADOS_FRETE.transportadoras.forEach(t => {
    if (t.prazos[cidade]) {

      const dadosCidade = t.prazos[cidade];

      const valorNF = t.valorPorNF <= 1 ? (t.valorPorNF * valor) : t.valorPorNF;
      const taxa = t.taxaColeta <= 1 ? (t.taxaColeta * valor) : t.taxaColeta;

      let total = t.valorPorKg * peso + valorNF + taxa;
      if (total < t.freteMinimo) total = t.freteMinimo;

      opcoes.push({
        nome: t.nome,
        prazo: dadosCidade.prazo,
        frete: total
      });
    }
  });

  if (opcoes.length === 0) {
    document.getElementById("resultado").innerHTML = "Cidade não encontrada.";
    return;
  }

  if (ordenar === "prazo") opcoes.sort((a, b) => a.prazo - b.prazo);
  else opcoes.sort((a, b) => a.frete - b.frete);

  let html = "<h3>Resultados:</h3>";

  opcoes.slice(0, 3).forEach((t, i) => {
    html += `
      <div class="${i === 0 ? 'melhor' : ''}">
        <strong>${t.nome}</strong><br>
        Prazo: ${t.prazo}h úteis<br>
        Frete: R$ ${t.frete.toFixed(2)}
      </div>
    `;
  });

  document.getElementById("resultado").innerHTML = html;
}

// ===============================
//   LIMPAR TUDO
// ===============================
function limparTudo() {
  document.getElementById("cidade").value = "";
  document.getElementById("uf").value = "";
  document.getElementById("cep").value = "";
  document.getElementById("peso").value = "";
  document.getElementById("valor").value = "";
  document.getElementById("resultado").innerHTML = "";
  window.__UF_SELECIONADA = null;
}

</script>
</body>
</html>
