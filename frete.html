<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Frete</title>

<style>
body {font-family: Arial, sans-serif; background:#f7f7f7; display:flex; justify-content:center; align-items:flex-start; padding-top:40px; margin:0;}
.container {background:white; padding:30px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-width:600px; width:95%;}
input, select {width:100%; padding:10px; margin:5px 0 15px; border-radius:6px; border:1px solid #ccc; font-size:16px;}
button {padding:10px 15px; font-size:14px; margin-top:10px; border:none; border-radius:6px; background:#2c7be5; color:white; cursor:pointer;}
button:hover {background:#1a5fcc;}
.resultado {margin-top:20px; padding:10px; background:#f3f3f3; border-radius:6px;}
.melhor {background-color:#d1f7c4; padding:5px; border-radius:4px; margin-bottom:5px;}

.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 99;
  top: 100%; 
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background-color: #fff;
}
.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #d4d4d4;
}
.autocomplete-active {background-color:#2c7be5 !important; color:#fff;}

.voltar-inicio {
    position: fixed;
    top: 10px;
    left: 20px;
    color: #2c7be5;
    padding: 8px 12px;
    text-decoration: none;
    font-weight: bold;
    font-size: 14px;
    z-index: 9999;
}
.voltar-inicio:hover {
    color: #1a5fcc;
}
</style>
</head> 

<body>

<a href="index.html" class="voltar-inicio">Voltar</a>

<div class="container">
  <h2>Cotação de Frete</h2>

  <div style="position:relative;">
    <label for="cidade">Cidade</label>
    <input type="text" id="cidade" placeholder="Digite a cidade">
  </div>

  <label for="peso">Peso total (kg)</label>
  <input type="number" id="peso" placeholder="Ex: 100" step="0.01">

  <label for="valor">Valor da mercadoria (R$)</label>
  <input type="number" id="valor" placeholder="Ex: 150.00" step="0.01">

  <label for="ordenar">Ordenar por</label>
  <select id="ordenar">
    <option value="prazo">Menor Prazo</option>
    <option value="valor">Menor Frete</option>
  </select>

  <button onclick="calcularFrete()">Calcular Frete</button>

  <div class="resultado" id="resultado"></div>
</div>

<script>
// =========================
//  CARREGAR JSON EXTERNO
// =========================

let dados = null;

async function carregarJSON() {
  try {
    const resp = await fetch("dados.json");
    dados = await resp.json();
    inicializar();
  } catch (e) {
    alert("Erro ao carregar dados.json");
  }
}

// =========================
//   INICIALIZAÇÃO
// =========================
function inicializar() {
  const todasCidades = new Set();

  dados.transportadoras.forEach(t => {
    Object.keys(t.prazos).forEach(c => todasCidades.add(c));
  });

  const cidades = Array.from(todasCidades).sort();

  setupAutocomplete(document.getElementById("cidade"), cidades);
}

// =========================
//   AUTOCOMPLETE
// =========================
function setupAutocomplete(inp, arr) {
  let currentFocus;

  inp.addEventListener("input", function () {

    const val = this.value.trim();
    closeAllLists();

    if (!val) return;

    currentFocus = -1;

    const list = document.createElement("div");
    list.setAttribute("id", this.id + "-autocomplete-list");
    list.setAttribute("class", "autocomplete-items");

    this.parentNode.appendChild(list);

    arr.forEach(item => {

      if (item.substr(0, val.length).toUpperCase() === val.toUpperCase()) {

        const itemDiv = document.createElement("div");
        itemDiv.innerHTML = "<strong>" + item.substr(0, val.length) + "</strong>" + item.substr(val.length);
        itemDiv.innerHTML += "<input type='hidden' value='" + item + "'>";

        itemDiv.addEventListener("click", function () {
          inp.value = this.getElementsByTagName("input")[0].value;
          closeAllLists();
        });

        list.appendChild(itemDiv);
      }

    });
  });

  inp.addEventListener("keydown", function (e) {

    let x = document.getElementById(this.id + "-autocomplete-list");
    if (x) x = x.getElementsByTagName("div");

    if (e.keyCode == 40) { // seta baixo
      currentFocus++;
      addActive(x);
    } else if (e.keyCode == 38) { // seta cima
      currentFocus--;
      addActive(x);
    } else if (e.keyCode == 13) { // enter
      e.preventDefault();
      if (currentFocus > -1) {
        if (x) x[currentFocus].click();
      }
    }
  });

  function addActive(x) {
    if (!x) return;
    removeActive(x);

    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = x.length - 1;

    x[currentFocus].classList.add("autocomplete-active");
  }

  function removeActive(x) {
    for (let i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }

  function closeAllLists(elmnt) {
    const items = document.getElementsByClassName("autocomplete-items");
    for (let i = 0; i < items.length; i++) {
      if (elmnt != items[i] && elmnt != inp) {
        items[i].parentNode.removeChild(items[i]);
      }
    }
  }

  document.addEventListener("click", function (e) {
    closeAllLists(e.target);
  });
}

// =========================
//   FORMATAR PRAZO
// =========================
function formatPrazo(horas) {
  if (typeof horas === "string") return horas;

  const dias = Math.floor(horas / 24);
  const restante = horas % 24;

  let str = "";
  if (dias > 0) str += `${dias} dia${dias > 1 ? "s" : ""} `;
  if (restante > 0) str += `${restante} hora${restante > 1 ? "s" : ""}`;

  return str.trim();
}

// =========================
//   CALCULAR FRETE
// =========================
function calcularFrete() {

  const cidade = document.getElementById("cidade").value.trim();
  const peso = parseFloat(document.getElementById("peso").value);
  const valorMercadoria = parseFloat(document.getElementById("valor").value);
  const ordenarPor = document.getElementById("ordenar").value;

  if (!cidade || isNaN(peso) || isNaN(valorMercadoria)) {
    alert("Preencha corretamente todos os campos");
    return;
  }

  let opcoes = dados.transportadoras.filter(t => t.prazos[cidade] !== undefined);

  if (opcoes.length === 0) {
    document.getElementById("resultado").innerText = "Nenhuma transportadora atende esta cidade.";
    return;
  }

  opcoes.forEach(t => {

    const valorNF = t.valorPorNF <= 1 ? (t.valorPorNF * valorMercadoria) : t.valorPorNF;
    const taxaColeta = t.taxaColeta <= 1 ? (t.taxaColeta * valorMercadoria) : t.taxaColeta;

    let freteTotal = (t.valorPorKg * peso) + valorNF + taxaColeta;

    if (t.freteMinimo && freteTotal < t.freteMinimo) {
      freteTotal = t.freteMinimo;
    }

    t.freteTotal = freteTotal;
    t.prazoCidade = t.prazos[cidade];

  });

  if (ordenarPor === "prazo") {
    opcoes.sort((a, b) => a.prazoCidade - b.prazoCidade);
  } else {
    opcoes.sort((a, b) => a.freteTotal - b.freteTotal);
  }

  let html = "<h3>Melhores transportadoras:</h3>";

  opcoes.slice(0, 3).forEach((t, i) => {
    html += `
      <div class="${i === 0 ? 'melhor' : ''}">
        <strong>${t.nome}</strong> — 
        Prazo: ${formatPrazo(t.prazoCidade)} —
        Frete: R$ ${t.freteTotal.toFixed(2)}
      </div>`;
  });

  document.getElementById("resultado").innerHTML = html;
}

// =========================
//   INICIAR
// =========================
carregarJSON();

</script>
</body>
</html>
