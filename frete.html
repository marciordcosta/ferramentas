<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calculadora de Frete</title>
<style>
  body {font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:40px 0; display:flex; justify-content:center;}
  .container {background:white; padding:30px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-width:600px; width:95%;}
  input, select {width:100%; padding:10px; margin:5px 0 15px; border-radius:6px; border:1px solid #ccc; font-size:16px;}
  button {padding:10px 15px; font-size:14px; margin-top:10px; border:none; border-radius:6px; background:#2c7be5; color:white; cursor:pointer;}
  button:hover {background:#1a5fcc;}
  .resultado {margin-top:20px; padding:10px; background:#f3f3f3; border-radius:6px;}
  .melhor {background:#d1f7c4; padding:6px; border-radius:4px; margin-bottom:5px;}
  .voltar-inicio {position: fixed; top:10px; left:20px; color:#2c7be5; text-decoration:none; font-weight:bold; font-size:14px;}
  .voltar-inicio:hover {color:#1a5fcc;}
  .autocomplete-items {position:absolute; border:1px solid #d4d4d4; border-top:none; z-index:99; background:#fff; max-height:200px; overflow-y:auto; width:100%;}
  .autocomplete-items div{padding:10px; cursor:pointer; border-bottom:1px solid #d4d4d4;}
  .autocomplete-active{background:#2c7be5 !important; color:#fff;}
</style>
</head>
<body>

<a href="index.html" class="voltar-inicio">Voltar</a>

<div class="container">
  <h2>Cotação de Frete</h2>

  <div style="position:relative;">
    <label for="cidade">Cidade</label>
    <input type="text" id="cidade" placeholder="Digite a cidade ou CEP">
  </div>

  <label for="peso">Peso total (kg)</label>
  <input type="number" id="peso" placeholder="Ex: 100" step="0.01">

  <label for="valor">Valor da mercadoria (R$)</label>
  <input type="number" id="valor" placeholder="Ex: 150.00" step="0.01">

  <label for="ordenar">Ordenar por</label>
  <select id="ordenar">
    <option value="prazo">Menor Prazo</option>
    <option value="valor">Menor Frete</option>
  </select>

  <button onclick="calcularFrete()">Calcular Frete</button>

  <div class="resultado" id="resultado"></div>
</div>

<script src="dados.js"></script>
<script>
let dados = window.DADOS_FRETE;
let cidadesIndex = {};
let cepsIndex = [];

function inicializar(){
  const setCidades = new Set();

  dados.transportadoras.forEach(t=>{
    Object.entries(t.prazos).forEach(([cidade, cfg])=>{
      setCidades.add(cidade);
      cidadesIndex[cidade.toLowerCase()] = cidade;

      if(cfg.cep_inicio && cfg.cep_fim){
        cepsIndex.push({
          cidade,
          inicio: cfg.cep_inicio.replace(/\D/g,""),
          fim: cfg.cep_fim.replace(/\D/g,"")
        });
      }
    });
  });

  setupAutocomplete(document.getElementById("cidade"), Array.from(setCidades).sort());
}

function buscarCidadeOuCep(valor){
  valor = valor.trim();
  if(!valor) return null;

  if(/^[0-9]{5}-?[0-9]{3}$/.test(valor)){
    let limpo = valor.replace(/\D/g,"");
    for(const faixa of cepsIndex){
      if(limpo >= faixa.inicio && limpo <= faixa.fim){
        return faixa.cidade;
      }
    }
    return null;
  }

  return cidadesIndex[valor.toLowerCase()] || null;
}

function setupAutocomplete(inp, arr){
  let currentFocus;

  inp.addEventListener("input", function(){
    const val = this.value;
    closeAllLists();
    if(!val) return;

    const list = document.createElement("div");
    list.setAttribute("id", this.id+"-autocomplete-list");
    list.setAttribute("class", "autocomplete-items");
    this.parentNode.appendChild(list);

    arr.forEach(item=>{
      if(item.toLowerCase().startsWith(val.toLowerCase())){
        const itemDiv = document.createElement("div");
        itemDiv.innerHTML = `<strong>${item.substr(0,val.length)}</strong>${item.substr(val.length)}`;
        itemDiv.innerHTML += `<input type='hidden' value='${item}'>`;
        itemDiv.onclick = () => { inp.value=item; closeAllLists(); };
        list.appendChild(itemDiv);
      }
    });
  });

  inp.addEventListener("keydown", function(e){
    let x=document.getElementById(this.id+"-autocomplete-list");
    if(x) x=x.getElementsByTagName("div");

    if(e.keyCode===40){ currentFocus++; addActive(x); }
    else if(e.keyCode===38){ currentFocus--; addActive(x); }
    else if(e.keyCode===13){ e.preventDefault(); if(currentFocus>-1 && x){ x[currentFocus].click(); }}
  });

  function addActive(x){ if(!x) return; removeActive(x);
    if(currentFocus>=x.length) currentFocus=0;
    if(currentFocus<0) currentFocus=x.length-1;
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x){ for(let i=0;i<x.length;i++) x[i].classList.remove("autocomplete-active"); }
  function closeAllLists(elmnt){
    const items=document.getElementsByClassName("autocomplete-items");
    for(let i=0;i<items.length;i++){
      if(elmnt!=items[i] && elmnt!=inp){ items[i].parentNode.removeChild(items[i]); }
    }
  }
  document.addEventListener("click", e=>closeAllLists(e.target));
}

function formatPrazo(cfg){ return cfg.prazo + "h | " + cfg.cep_inicio + " a " + cfg.cep_fim; }

function calcularFrete(){
  let entrada = document.getElementById("cidade").value.trim();
  const cidade = buscarCidadeOuCep(entrada);

  if(!cidade){
    document.getElementById("resultado").innerHTML = "⚠️ Cidade ou CEP não encontrado";
    return;
  }

  const peso = parseFloat(document.getElementById("peso").value);
  const valorMercadoria = parseFloat(document.getElementById("valor").value);
  const ordenarPor = document.getElementById("ordenar").value;

  if(isNaN(peso) || isNaN(valorMercadoria)){
    alert("Preencha peso e valor corretamente");
    return;
  }

  let opcoes = [];

  dados.transportadoras.forEach(t=>{
    const cfg = t.prazos[cidade];
    if(cfg){
      const valorNF = t.valorPorNF <= 1 ? t.valorPorNF*valorMercadoria : t.valorPorNF;
      const taxa = t.taxaColeta <= 1 ? t.taxaColeta*valorMercadoria : t.taxaColeta;
      let total = (t.valorPorKg*peso) + valorNF + taxa;

      if(t.freteMinimo && total < t.freteMinimo) total = t.freteMinimo;

      opcoes.push({
        nome: t.nome,
        prazo: cfg.prazo,
        faixa: cfg,
        valor: total
      });
    }
  });

  if(opcoes.length===0){
    document.getElementById("resultado").innerText = "Nenhuma transportadora atende esta cidade.";
    return;
  }

  if(ordenarPor==="prazo") opcoes.sort((a,b)=>a.prazo-b.prazo);
  else opcoes.sort((a,b)=>a.valor-b.valor);

  let html = "<h3>Melhores transportadoras:</h3>";
  opcoes.slice(0,3).forEach((t,i)=>{
    html += `<div class='${i===0?"melhor":""}'>
      <strong>${t.nome}</strong> — Prazo: ${t.prazo}h — Faixa CEP: ${t.faixa.cep_inicio} a ${t.faixa.cep_fim} — Frete: R$ ${t.valor.toFixed(2)}
    </div>`;
  });

  document.getElementById("resultado").innerHTML = html;
}

inicializar();
</script>

</body>
</html>
