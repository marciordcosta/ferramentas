<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerar PIX</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f9f9f9;
  margin: 0;
  padding: 20px;
  text-align: center;
}
.container {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  display: inline-block;
  text-align: left;
  max-width: 400px;
}
h2 {
  text-align:center;
  color:#333;
}
input, select {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  font-size: 14px;
}
button {
  padding: 10px 15px;
  margin: 15px 0;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  transition: background 0.3s ease;
}
.btn-gerar {
  background-color: #2c7be5;
}
.btn-gerar:hover {
  background-color: #1a5fcc;
}
.btn-copiar {
  background-color: #28a745;
}
.btn-copiar:hover {
  background-color: #1e7e34;
}
.btn-pdf {
  background-color: #fd7e14;
}
.btn-pdf:hover {
  background-color: #e86c0f;
}
#pixVisual {
  text-align: center;
  margin-top: 20px;
}
#pixCode {
  word-break: break-all;
  background: #f3f3f3;
  padding: 10px;
  border-radius: 6px;
  margin-top: 10px;
  font-size: 13px;
}
</style>
</head>
<body>

<div class="container">
  <h2>Gerar PIX</h2>

  <label>Selecione o banco/chave</label>
  <select id="banco">
   <option value="05541695000132" data-nome="Banco do Brasil">Banco do Brasil PJ</option>
   <option value="48426245315" data-nome="Banco do Brasil">Banco do Brasil (Ivan)</option>
   <option value="34471704000164" data-nome="Agro Cearense">Agro Cearense</option>
  </select>

  <label>Valor (R$)</label>
  <input type="number" id="valor" placeholder="Ex: 150.00" step="0.01">

  <label>Número do Pedido</label>
  <input type="text" id="nf" placeholder="Ex: 12345">
  
  <button class="btn-gerar" onclick="gerarPix()">Gerar PIX</button>

  <div id="pixVisual" style="display:none;">
    <h3 id="pixTitulo"></h3>
    <p id="pixValor"></p>
    <p id="pixBanco"></p>
    <p id="pixBeneficiario"></p>
    <canvas id="qrCodeView" width="200" height="200"></canvas>
    <div id="pixCode"></div>
    <button class="btn-copiar" onclick="copiarPix()">Copiar PIX</button>
    <button class="btn-pdf" onclick="baixarPDF()">Baixar PDF</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const RECEIVER_NAME = 'Ceara Sementes';
const RECEIVER_CITY = 'FORTALEZA';
const CURRENCY = '986';
const COUNTRY = 'BR';
let codigoGerado = "";
const BENEFICIARIOS = {
  "05541695000132": "Francisco Ivan Costa Flores",
  "48426245315": "Francisco Ivan Costa",
  "34471704000164": "Larissa Firmino da Costa ME"
};

function tlv(tag, value) {
  const len = new TextEncoder().encode(value).length;
  return tag + String(len).padStart(2, '0') + value;
}

function crc16(payload) {
  const poly = 0x1021;
  let crc = 0xFFFF;
  const bytes = new TextEncoder().encode(payload);
  for (let i = 0; i < bytes.length; i++) {
    crc ^= (bytes[i] << 8);
    for (let j = 0; j < 8; j++) {
      crc = (crc & 0x8000) ? ((crc << 1) ^ poly) : (crc << 1);
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

function buildPixPayload(valorStr, chave, txid) {
  const valorNum = Number(valorStr.replace(',', '.'));
  if (!valorNum || valorNum <= 0) throw new Error('Valor inválido');
  const valor = valorNum.toFixed(2);

  let safeTxid = txid ? txid.replace(/[^0-9A-Za-z\-_.]/g, '').substring(0, 25) : '';

  let payload = '';
  payload += tlv('00', '01');

  let mai = '';
  mai += tlv('00', 'BR.GOV.BCB.PIX');
  mai += tlv('01', chave);
  payload += tlv('26', mai);

  payload += tlv('52','0000'); 
  payload += tlv('53',CURRENCY); 
  payload += tlv('54',valor); 
  payload += tlv('58',COUNTRY); 

  // Aqui usamos o beneficiário correspondente à chave
  const beneficiario = BENEFICIARIOS[chave] || RECEIVER_NAME;
  payload += tlv('59', beneficiario.substring(0,25)); 

  payload += tlv('60',RECEIVER_CITY.substring(0,15)); 
  if(safeTxid) payload += tlv('62', tlv('05',safeTxid)); 

  const payloadForCrc = payload+'6304';
  const crc = crc16(payloadForCrc);
  payload += tlv('63',crc);

  return payload;
}


function gerarTxid() {
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
  let s = '';
  for (let i = 0; i < 10; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
  return s;
}

function gerarPix() {
  const valor = document.getElementById('valor').value.trim();
  const nf = document.getElementById('nf').value.trim();
  const selectBanco = document.getElementById('banco');
  const chave = selectBanco.value;
  const nomeBanco = selectBanco.selectedOptions[0].getAttribute('data-nome');
  const beneficiario = BENEFICIARIOS[chave] || RECEIVER_NAME;
  const txid = nf || gerarTxid();

  try {
    const payload = buildPixPayload(valor, chave, txid);
    codigoGerado = payload;

    document.getElementById('pixTitulo').innerText = nf ? `Pedido: ${nf}` : 'Pagamento PIX';
    document.getElementById('pixValor').innerText = `Valor: R$ ${parseFloat(valor).toFixed(2)}`;
    document.getElementById('pixBanco').innerText = `Banco: ${nomeBanco}`;
    document.getElementById('pixBeneficiario').innerText = `Beneficiário: ${beneficiario}`;
    document.getElementById('pixCode').innerText = payload;
    document.getElementById('pixVisual').style.display = 'block';

    new QRious({
      element: document.getElementById('qrCodeView'),
      value: payload,
      size: 200
    });
  } catch (err) {
    alert(err.message);
  }
}

function copiarPix() {
  if (!codigoGerado) return alert('Gere o código primeiro.');
  navigator.clipboard.writeText(codigoGerado).then(() => alert('Código PIX copiado!'));
}

async function baixarPDF() {
  if (!codigoGerado) return alert('Gere o código primeiro.');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const nf = document.getElementById('nf').value.trim();
  const valor = document.getElementById('valor').value.trim();
  const selectBanco = document.getElementById('banco');
  const chave = selectBanco.value;
  const nomeBanco = selectBanco.selectedOptions[0].getAttribute('data-nome');
  const beneficiario = BENEFICIARIOS[chave] || RECEIVER_NAME;

  // Aqui criamos as variáveis corretamente
  const nfTexto = nf ? `Pedido: ${nf}` : '';
  const valorTexto = valor ? `Valor: R$${parseFloat(valor).toFixed(2)}` : '';

  // Gerar QR Code em memória
  const qr = new QRious({ value: codigoGerado, size: 200 });
  const imgData = qr.toDataURL();

  // Texto do PDF
  doc.setFontSize(16);
  doc.text("Pagamento via PIX", 20, 20);
  if (nfTexto) doc.setFontSize(12).text(nfTexto, 20, 28);
  if (valorTexto) doc.setFontSize(12).text(valorTexto, 20, 36);
  doc.setFontSize(12);
  doc.text(`Banco: ${nomeBanco}`, 20, 44);
  doc.text(`Beneficiário: ${beneficiario}`, 20, 50);
  doc.text(`Chave: ${chave}`, 20, 56);
  doc.text("Escaneie o QR Code abaixo:", 20, 66);

  doc.addImage(imgData, 'PNG', 60, 75, 90, 90);

  doc.setFontSize(10);
  doc.text("Código PIX:", 20, 170);
  doc.setFontSize(8);
  const linhas = doc.splitTextToSize(codigoGerado, 170);
  doc.text(linhas, 20, 176);

  const valorArquivo = valor ? parseFloat(valor).toFixed(2) : '';
  const nomeArquivo = nf ? `PIX_${nf}_${valorArquivo}.pdf` : `PIX_${valorArquivo}.pdf`;
  doc.save(nomeArquivo.replace(/\s+/g,''));
}

</script>
</body>
</html>
